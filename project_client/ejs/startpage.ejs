<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/startpage.css">
    <link rel="stylesheet" href="/startpage2.css">
    <link rel="stylesheet" href="/startpage-result.css">
    <link rel="stylesheet" href="/startpage-options.css">
    <link rel="stylesheet" href="/startpage-tools.css">
    <link rel="stylesheet" href="/startpage-query.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/json-viewer-js@1.0.1/dist/json-viewer.css">
    <script src="https://cdn.jsdelivr.net/npm/json-viewer-js@1.0.1/dist/json-viewer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="main">
        <div id="top-bar">
            <div id="heading">
                <a href="/">Data<span>Nest</span></a>
            </div>

            <div id="user">
                <div class="user-avatar" id="user-toggle">
                    <%= username.charAt(0).toUpperCase() %>
                </div>

                <div id="user-name">
                    <%= username.charAt(0).toUpperCase() + username.slice(1) %>
                </div>

                <!-- Dropdown -->
                <form id="user-dropdown" class="hidden" action="/user_dropdown" method="POST">
                    <button type="submit" name="submit" value="profile" class="dropdown-item">üë§ Profile</button>
                    <button type="submit" name="submit" value="logout" class="dropdown-item logout">üö™ Logout</button> 
                    <!-- //employ the cache deleting logic again -->
                </form>
            </div>
            <script>
                const userToggle = document.getElementById("user-toggle");
                const dropdown = document.getElementById("user-dropdown");

                userToggle.addEventListener("click", (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle("hidden");
                });

                // Close on outside click
                document.addEventListener("click", () => {
                    dropdown.classList.add("hidden");
                });
            </script>

        </div>

        <div id="main-panel">
            <div id="side-bar">
                <div id="side-bar-heading">View</div>
                <div id="sidebar-search">
                    <input 
                        type="text" 
                        id="sidebar-search-input" 
                        placeholder="Search files or databases..."
                        onkeyup="filterSidebar()"
                    />
                </div>
                <div id="side-bar-content">
                    <% for (let database of databases) { %>
                        <div class="database-name">
                            <span>‚ñ∂</span>
                            &nbsp; üóÑÔ∏è <%= database.database_name %>
                            <ul class="filelist">
                                <% for (let file of database.database_files) { %>
                                    <li class="filename">
                                        <% if (file.split(".")[1] === 'txt') { %>
                                            üìä
                                        <% } else { %>
                                            {}
                                        <% } %>
                                        <%= file.split(".")[0] %>

                                        <div class="filename-hidden"><%= file.split(".")[1] %></div>
                                        <div class="filenamefull_hidden"><%= file %></div>
                                        <div class="databasename_hidden"><%= database.database_name %></div>
                                    </li>
                                <% } %>
                            </ul>
                        </div>
                    <% } %>
                </div>
            </div>

            <div id="main-workspace">
                <div id="tools">
                    <form id="tools-form" action="/tools" method="POST">
                        <input type="hidden" id="form-filename" name="filename">
                        <input type="hidden" id="form-databasename" name="databasename">

                        <div id="tool-mode">Tool Mode</div>

                        <div class="button-set" id="button-set-1">
                            <button type="button" onclick="showbuttonset('2')">Create</button>
                            <button type="button" onclick="showbuttonset('7')">Delete</button>
                            <button type="button" onclick="showbuttonset('8')">Rename</button>
                            <button type="submit" name="tool" value="import">Import</button>
                            <button type="submit" name="tool" value="export">Export</button>
                        </div>

                        <div class="button-set" id="button-set-2">
                            <button type="button" class="back" onclick="showbuttonset('1')">‚Üê Back</button>
                            <button type="submit" name="tool" value="Insert Database">Insert Database</button>
                            <button type="submit" name="tool" value="Insert File">Insert File</button>
                        </div>

                        <div class="button-set" id="button-set-7">
                            <button type="button" class="back" onclick="showbuttonset('1')">‚Üê Back</button>
                            <button type="submit" name="tool" value="Delete Database">Delete Database</button>
                            <button type="submit" name="tool" value="Delete File">Delete File</button>
                        </div>

                        <div class="button-set" id="button-set-8">
                            <button type="button" class="back" onclick="showbuttonset('1')">‚Üê Back</button>
                            <button type="submit" name="tool" value="Rename Database">Rename Database</button>
                            <button type="submit" name="tool" value="Rename File">Rename File</button>
                        </div>

                        <div class="button-set" id="button-set-3">
                            <button type="button" class="back" onclick="showbuttonset('1')">‚Üê Back</button>
                            <button type="submit" name="tool" value="insertrow">Insert Row</button>
                            <button type="submit" name="tool" value="selectrow">Select Row</button>
                            <button type="submit" name="tool" value="updaterow">Update Row</button>
                            <button type="submit" name="tool" value="deleterow">Delete Row</button>
                            <span class="divider"></span>
                            <button type="submit" name="tool" value="tableschema">Schema</button>
                            <button type="submit" name="tool" value="querytool">Query</button>
                            <button type="button" onclick="showbuttonset('5')">Join</button>
                            <button type="button" onclick="showbuttonset('6')">Split</button>
                            <button type="submit" name="tool" value="sort">Sort</button>
                            <button type="submit" name="tool" value="visualizedata">Visualize Data</button>
                        </div>


                        <div class="button-set" id="button-set-4">
                            <button type="button" class="back" onclick="showbuttonset('1')">‚Üê Back</button>
                            <button type=submit class="select-menu-item" name="tool" value="insertkeyvalue">Insert Key-Value</button>
                            <button type=submit class="select-menu-item" name="tool" value="selectkeyvalue">Select Key-Value</button>
                            <button type=submit class="select-menu-item" name="tool" value="updatekeyvalue">Update Key-Value</button>
                            <button type=submit class="select-menu-item" name="tool" value="deletekeyvalue">Delete Key-Value</button>
                            <span class="divider"></span>
                            <button type=submit class="select-menu-item" name="tool" value="jsonschema">Schema</button>
                            <button type=submit class="select-menu-item" name="tool" value="querytool">Query</button>
                            <button type=submit class="select-menu-item" name="tool" value="find">Find</button>
                        </div>

                        <div class="button-set" id="button-set-5">
                            <button type="button" class="back" onclick="showbuttonset('3')">‚Üê Back</button>
                            <button type="submit" name="tool" value="innerjoin">Inner Join</button>
                            <button type="submit" name="tool" value="leftjoin">Left Join</button>
                            <button type="submit" name="tool" value="rightjoin">Right Join</button>
                            <button type="submit" name="tool" value="outerjoin">Outer Join</button>
                            <button type="submit" name="tool" value="crossjoin">Cross Join</button>
                        </div>

                        <div class="button-set" id="button-set-6">
                            <button type="button" class="back" onclick="showbuttonset('3')">‚Üê Back</button>
                            <button type="submit" name="tool" value="horizontalsplit">Horizontal Split</button>
                            <button type="submit" name="tool" value="verticalsplit">Vertical Split</button>
                        </div>
                    </form>
                </div>

                <div id="query">
                    <div id="query-space">
                        <% if (message1 === 'querytool'){ %>
                            <div id="query-tool">

                                <!-- HEADER -->
                                <div class="query-header">
                                    <span>Database: <b><%= databasename %></b></span>
                                    <span>File: <b><%= filename %></b></span>
                                </div>

                                <!-- BODY -->
                                <div class="query-body">

                                    <!-- LEFT TABS -->
                                    <div class="query-sidebar">
                                        <div class="query-tab active" data-tab="editor">Editor</div>
                                        <div class="query-tab" data-tab="history">History</div>
                                    </div>

                                    <!-- MAIN -->
                                    <div class="query-main">

                                        <!-- EDITOR -->
                                        <form action="/querytool" method="POST" id="query-form" class="query-panel active">
                                            <input type="hidden" name="filename" value="<%= filename %>">
                                            <input type="hidden" name="databasename" value="<%= databasename %>">

                                            <textarea name="query" id="query-editor"
                                                placeholder="SELECT * FROM table;"></textarea>
                                        </form>

                                        <!-- HISTORY -->
                                        <div class="query-panel" id="query-history">
                                            <div class="history-empty">No queries yet</div>
                                        </div>

                                    </div>
                                </div>

                                <!-- FOOTER -->
                                <div class="query-footer">
                                    <button type="button" class="query-run" onclick="runQuery()">Run</button>
                                    <button type="button" class="query-clear" onclick="clearQuery()">Clear</button>
                                    <span class="query-hint">Ctrl + Enter to Run</span>
                                </div>

                            </div>
                            <script>
                            const tabs = document.querySelectorAll('.query-tab');
                            const panels = document.querySelectorAll('.query-panel');
                            const editor = document.getElementById('query-editor');
                            const historyPanel = document.getElementById('query-history');

                            const queryHistory = <%- JSON.stringify(extra_data.data)%>;

                            // TAB SWITCH
                            tabs.forEach(tab => {
                                tab.addEventListener('click', () => {
                                    tabs.forEach(t => t.classList.remove('active'));
                                    panels.forEach(p => p.classList.remove('active'));

                                    tab.classList.add('active');
                                    document.querySelector(
                                        tab.dataset.tab === 'editor'
                                            ? '#query-form'
                                            : '#query-history'
                                    ).classList.add('active');

                                    if (tab.dataset.tab === 'history'){
                                        renderHistory();
                                    }
                                });
                            });

                            // RUN QUERY
                            function runQuery(){
                                const value = editor.value.trim();
                                if (!value) return;

                                // queryHistory.unshift(value);
                                renderHistory();
                                document.getElementById('query-form').submit();
                            }

                            // CLEAR
                            function clearQuery(){
                                editor.value = '';
                            }

                            // HISTORY RENDER
                            function renderHistory(){
                                historyPanel.innerHTML = '';
                                queryHistory.forEach(q => {
                                    const div = document.createElement('div');
                                    div.className = 'history-item';
                                    div.textContent = q;
                                    div.onclick = () => {
                                        editor.value = q;
                                        tabs[0].click();
                                    };
                                    historyPanel.appendChild(div);
                                });
                            }

                            // CTRL + ENTER
                            editor.addEventListener('keydown', e => {
                                if (e.ctrlKey && e.key === 'Enter') {
                                    runQuery();
                                }
                            });
                            </script>

                            <% } %>
                    </div>
                    <div id="options">
                        <div class="options-header">Properties</div>

                        <div class="options-body">

                            <% if (message1 === 'tableschema'){ %>
                                <div class="options-meta">
                                    <div class="options-meta-info">
                                        <div><b>Database:</b> <%= databasename %></div>
                                        <div><b>File:</b> <%= filename %></div>
                                    </div>
                                    <div>
                                        <button type="submit" form="tools-form" name="tool" value="changeschema" onclick="populate_required_data()">Change</button>
                                        <script>
                                            function populate_required_data(){
                                                document.getElementById('form-databasename').value="<%=databasename%>";
                                                document.getElementById('form-filename').value="<%=filename%>";
                                            }
                                        </script>
                                    </div>
                                </div>

                                <div class="schema-card">
                                    <div class="schema-title">Table Schema</div>

                                    <table class="schema-table">
                                        <thead>
                                            <tr>
                                                <th>Column</th>
                                                <th>Type</th>
                                                <th>Expression</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% for (let column of extra_data.data.columns){ %>
                                            <tr>
                                                <td><%= column.name %></td>
                                                <td>
                                                    <div class="type-wrap">
                                                        <span class="type-badge <%= column.type %>">
                                                            <%= column.type.toUpperCase() %>
                                                        </span>

                                                        <% if (column.constraints && column.constraints.length){ %>
                                                            <div class="constraint-wrap">
                                                                <% column.constraints.forEach(c => { %>
                                                                    <span class="constraint-badge <%= c %>">
                                                                        <%= c.replace('_',' ').toUpperCase() %>
                                                                    </span>
                                                                <% }) %>
                                                            </div>
                                                        <% } %>
                                                    </div>
                                                </td>
                                                <td>
                                                    <% if (column.expression !== '') { %>
                                                        <%= column.expression %>
                                                    <% } else { %>
                                                        <span class="null">NULL</span>
                                                    <% } %>
                                                </td>
                                            </tr>
                                            <% } %>
                                        </tbody>
                                    </table>

                                    <div class="schema-footer">
                                        Rows: <%= extra_data.data.rows.length %>
                                    </div>
                                </div>

                            <% } %>


                            <% if (message1 === 'jsonschema'){ %>
                                <script>
                                    document.querySelector('.popup').style.display='none';
                                </script>
                                <div class="options-meta">
                                    <div><b>Database:</b> <%= databasename %></div>
                                    <div><b>File:</b> <%= filename %></div>
                                </div>

                                <div class="schema-card">
                                    <div class="schema-title">JSON Schema</div>

                                    <div class="json-schema-list">
                                        <% for (let key in extra_data.data) { %>
                                            <div class="json-schema-row">
                                                <span class="json-key"><%= key %></span>
                                                <span class="json-type">
                                                    <% if (Array.isArray(extra_data.data[key])) { %>
                                                        Array
                                                    <% } else if (typeof extra_data.data[key] === 'object') { %>
                                                        Object
                                                    <% } else { %>
                                                        Value
                                                    <% } %>
                                                </span>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>

                            <% } %>

                        </div>
                    </div>

                </div>

                <div id="result">
                    <div class="result-header">
                        <span class="result-title">Output</span>
                        <div class="result-buttons">
                            <button type="button" onclick="maximize_result()">‚ñ≤</button>
                            <button type="button" onclick="minimize_result()">‚ñº</button>
                        </div>
                        <script>
                            function maximize_result(){
                                document.getElementById('result').style.height='83.5vh';
                                document.getElementById('query').style.clipPath='inset(0 0 100% 0)';
                                document.getElementById('options').style.height='0vh';
                                document.querySelector('.options-header').style.display='none';
                                document.querySelector('.result-content').style.height = '72vh';
                            }
                            function minimize_result(){
                                document.getElementById('result').style.height='39vh';
                                document.getElementById('query').style.clipPath='inset(0 0 0 0)';
                                document.getElementById('options').style.height='45vh';
                                document.querySelector('.result-content').style.height = '32vh';
                                document.querySelector('.options-header').style.display='flex';
                            }
                        </script>
                    </div>

                    <% if (message) { %>
                        <div class="result-message">
                            <%= message %> <%= time ? `, ${time}` : ''%>
                        </div>
                    <% } %>

                    <div class="result-content">
                        <% if (type === 'table') { %>
                            <div class="table-meta">
                                <span>üìÑ <b>File:</b> <%= filename %></span>
                                <span>üóÑ <b>Database:</b> <%= databasename %></span>
                                <span>üìä <b>Rows:</b> <%= extra_data.rows.length %></span>
                            </div>

                            <div class="table-wrapper">
                            <table class="result-table">
                                <thead>
                                    <tr>
                                        <% for (let column of extra_data.columns) { %>
                                            <th class="<%= column.type %>">
                                                <%= column.name %>
                                                <span class="col-type <%= column.type %>">
                                                    <%= column.type.toUpperCase() %>
                                                </span>

                                                <!-- constraint icons -->
                                                <span class="constraints">
                                                    <% if (column.constraints.includes('primary_key')) { %>
                                                        <span class="constraint pk" title="Primary Key">üîë</span>
                                                    <% } %>
                                                    <% if (column.constraints.includes('unique')) { %>
                                                        <span class="constraint uq" title="Unique">‚≠ê</span>
                                                    <% } %>
                                                    <% if (column.constraints.includes('not_null')) { %>
                                                        <span class="constraint nn" title="Not Null">üîí</span>
                                                    <% } %>
                                                    <% if (column.constraints.includes('serial')) { %>
                                                        <span class="constraint sr" title="Auto Increment">üîÅ</span>
                                                    <% } %>
                                                </span>

                                            </th>
                                        <% } %>
                                    </tr>
                                </thead>

                                <tbody>
                                    <% for (let row of extra_data.rows) { %>
                                        <tr>
                                            <% for (let column of extra_data.columns) { %>
                                                <td class="<%= column.type %>">
                                                    <% if (row[column.name] !== null && row[column.name] !== undefined && row[column.name] !== '') { %>
                                                        <%= row[column.name] %>
                                                    <% } else if (row[column.name] === '') { %>
                                                        <span class="null">_</span>
                                                    <% } else { %>
                                                        <span class="null">NULL</span>
                                                    <%}%>
                                                </td>
                                            <% } %>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                            </div>


                        <% } else if (type === 'json') { %>
                            <div class="json-meta">
                                <span>üìÑ <b>File:</b> <%= filename %></span>
                                <span>üóÑ <b>Database:</b> <%= databasename %></span>

                                <div class="json-actions result-buttons">
                                    <button onclick="toggleJSONView()">Toggle View</button>
                                    <button onclick="copyJSON()">Copy JSON</button>
                                </div>
                            </div>

                            <div id="json-container" class="json-viewer">

                                <% function renderJSON(value, level = 0) { %>

                                    <% if (Array.isArray(value)) { %>
                                        <div style="margin-left:<%= level * 18 %>px">
                                            <span class="toggle" onclick="toggleBlock(event, this)">‚ñ∂</span>
                                            <span class="brace">[</span>
                                            <span class="array-info <%= value.length >= 5 ? 'large' : '' %>">
                                                <%= value.length %> items
                                            </span>

                                            <div class="json-block hidden">
                                                <% value.forEach(v => { %>
                                                    <%= renderJSON(v, level + 1) %>
                                                <% }) %>
                                            </div>
                                            <span class="brace">]</span>
                                        </div>

                                    <% } else if (typeof value === 'object' && value !== null) { %>
                                        <div style="margin-left:<%= level * 18 %>px">
                                            <span class="toggle" onclick="toggleBlock(event, this)">‚ñ∂</span>
                                            <span class="brace">{</span>

                                            <div class="json-block hidden">
                                                <% for (let k in value) { %>
                                                    <div class="json-row">
                                                        <span class="json-key">"<%= k %>"</span> :
                                                        <%= renderJSON(value[k], level + 1) %>
                                                    </div>
                                                <% } %>
                                            </div>
                                            <span class="brace">}</span>
                                        </div>

                                    <% } else { %>
                                        <div class="json-row" style="margin-left:<%= level * 18 %>px">
                                            <% if (typeof value === 'string') { %>
                                                <span class="json-value string">"<%= value %>"</span>
                                            <% } else { %>
                                                <span class="json-value number"><%= value %></span>
                                            <% } %>
                                        </div>
                                    <% } %>

                                <% } %>

                                <!-- formatted view rendered initially -->
                                <div id="json-formatted">
                                    <%= renderJSON(extra_data) %>
                                </div>

                                <!-- raw view (hidden initially) -->
                                <pre id="json-raw" class="hidden"><%= JSON.stringify(extra_data, null, 2) %></pre>

                            </div>

                            <script>
                                let isFormatted = true;

                                function toggleJSONView(){
                                    const formatted = document.getElementById('json-formatted');
                                    const raw = document.getElementById('json-raw');

                                    if (isFormatted){
                                        formatted.classList.add('hidden');
                                        raw.classList.remove('hidden');
                                    } else {
                                        raw.classList.add('hidden');
                                        formatted.classList.remove('hidden');
                                    }
                                    isFormatted = !isFormatted;
                                }

                                function toggleBlock(e, el){
                                    e.stopPropagation();
                                    const block = el.parentElement.querySelector('.json-block');
                                    block.classList.toggle('hidden');
                                    el.textContent = block.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
                                }

                                function copyJSON(){
                                    navigator.clipboard.writeText(
                                        JSON.stringify(<%- JSON.stringify(extra_data) %>, null, 2)
                                    );
                                    alert('JSON copied');
                                }
                            </script>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        <% if (message1){ %>
            <div id="popup" class="popup">
            
            <%if (message1 === 'export'){%>
                <form action="/export" class="popup-card" method="POST">

                    <div class="popup-header popup-drag-handle">
                        <span>Export File</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <label class="popup-label">Select Database</label>
                            <select name="database" id="export-file-database-select" class="popup-input">
                                <% for (let database of databases) { %>
                                    <option value="<%= database.database_name %>">
                                        <%= database.database_name %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="popup-field">
                            <label class="popup-label">Select File</label>
                            <select name="file" id="export-file-select" class="popup-input">
                                <%for (let file of databases[0].database_files){ %>
                                    <option value="<%= file%>"><%= file%></option>
                                <%}%>
                            </select>
                        </div>
                    </div>
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Export</button>
                    </div>                             
                </form>
                <script>
                    let export_databases = <%- JSON.stringify(databases)%>;
                    document.getElementById('export-file-database-select').addEventListener('change', (e)=>{
                        const select = document.querySelector('#export-file-select');
                        let files;
                        for (let i=0; i<export_databases.length; i++){
                            if (export_databases[i].database_name === e.target.value){
                                files = export_databases[i].database_files;
                                break;
                            }
                        }
                        
                        let export_file_select_innerText;
                        for (let file of files){
                            export_file_select_innerText+=`
                                <option value="${file}">${file}</option>
                            `;
                        }
                        select.innerHTML = export_file_select_innerText;
                    });
                </script>
            <%}%>

            <%if (message1 === 'import'){ %>
                <form action="/import" class="popup-card" method="POST" enctype="multipart/form-data">

                    <div class="popup-header popup-drag-handle">
                        <span>Import File</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <div class="popup-body">

                        <!-- File name -->
                        <div class="popup-field">
                            <label class="popup-label">File name</label>
                            <input type="text" name="filename" class="popup-input">
                        </div>

                        <div class="popup-field">
                            <label for="selectfile" class="popup-label">Select File</label>
                            <input type="file" name="file" accept=".csv,.tsv" id="datafile">
                        </div>

                        <!-- Select database -->
                        <div class="popup-field">
                            <label class="popup-label">Select database</label>
                            <select name="databaseselect" id="databaseselect" class="popup-input">
                                <% for (let database of databases) { %>
                                    <option value="<%= database.database_name %>">
                                        <%= database.database_name %>
                                    </option>
                                <% } %>
                            </select>
                        </div>

                        <!-- File type -->
                        <div class="popup-field">
                            <label class="popup-label">File type</label>
                            <select name="filetypeselect" id="import-filetypeselect" class="popup-input">
                                <option value="">None</option>
                                <option value="table">Table</option>
                                <option value="json">Object</option>
                            </select>
                        </div>

                        <!-- Dynamic section (Table builder / JSON info) -->
                        <div class="popup-field" id="import-file-builder" style="display:none;">
                            <div class="popup-label" id="import-fileheader"></div>
                            <div id="import-filecontents"></div>
                        </div>

                    </div>
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Import</button>
                    </div>                             
                </form>
                <script>
                    function import_add_column(){
                        import_column_count +=1;
                        document.querySelector('#import-filecontents-table').innerHTML +=`
                        <tr>
                                <td><input type="text" name="columnname${import_column_count}"></td>
                                <td>
                                    <select name="columntype${import_column_count}" class="column-type">
                                        <option value="int">Int</option>
                                        <option value="float">Float</option>
                                        <option value="string">String</option>    
                                    </select>
                                </td>
                                <td class="constraints">
                                    <input type="checkbox" name="notnull${import_column_count}">&nbsp;
                                    <label for="notnull${import_column_count}">Not Null</label>&nbsp;

                                    <input type="checkbox" name="primarykey${import_column_count}">&nbsp;
                                    <label for="primarykey${import_column_count}">Primary Key</label>&nbsp;

                                    <input type="checkbox" name="unique${import_column_count}">&nbsp;
                                    <label for="unique${import_column_count}">Unique</label>&nbsp;

                                    <input type="checkbox" name="serial${import_column_count}">&nbsp;
                                    <label for="serial${import_column_count}">Serial</label>
                                </td>
                        </tr>
                        `;
                    }

                    let import_column_count = 1;
                    const import_filetypeselect = document.querySelector('#import-filetypeselect');
                    if (import_filetypeselect){
                        import_filetypeselect.addEventListener('change', function(){
                            if (this.value === 'table'){
                    
                                document.querySelector('#import-file-builder').style.display='block';
                                document.querySelector('#import-fileheader').style.display='flex';
                                document.querySelector('#import-fileheader').innerHTML = `
                                    Add Column(s)
                                    &nbsp;
                                    <button type="button" onclick="import_add_column()">+</button>
                                `;

                                document.querySelector('#import-filecontents').innerHTML = `
                                    <table id="import-filecontents-table">
                                        <tr>
                                            <th>Column Name</th>
                                            <th>Column Type</th>
                                            <th>Column Constraint</th>
                                        </tr>
                                        <tr>
                                            <td><input type="text" name="columnname1"></td>    
                                            <td class="column-type-div">
                                                <select name="columntype1" class="column-type">
                                                    <option value="int">Int</option>
                                                    <option value="float">Float</option>
                                                    <option value="string">String</option>  
                                                </select>  
                                            </td>
                                            <td class="constraints">
                                                <input type="checkbox" name="notnull1">&nbsp;
                                                <label for="notnull1">Not Null</label>&nbsp;

                                                <input type="checkbox" name="primarykey1">&nbsp;
                                                <label for="primarykey1">Primary Key</label>&nbsp;

                                                <input type="checkbox" name="unique1">&nbsp;
                                                <label for="unique1">Unique</label>&nbsp;

                                                <input type="checkbox" name="serial1">&nbsp;
                                                <label for="serial1">Serial</label>
                                            </td>
                                        </tr>    
                                    </table>
                                `;
                            }
                            else if (this.value === 'json'){
                                document.querySelector('#import-file-builder').style.display='none';
                                document.querySelector('#import-fileheader').style.display='none';
                            }
                        });
                    }

                    document.addEventListener('change', function (e) {
                        if (!e.target.name.startsWith('primarykey')) return;

                        if (e.target.checked) {
                            document
                                .querySelectorAll('input[name^="primarykey"]')
                                .forEach(cb => {
                                    if (cb !== e.target) cb.checked = false;
                                });
                        }
                    });

                </script>
            <%}%>
            <%if (message1 === 'changeschema'){ %>
                <form action="/changeschema" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Change Schema</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>     
                    
                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>  

                        <div class="popup-field">
                            <div class="popup-label">Change</div>
                            <div class="chart-switch">
                                <button type="button" class="switch-btn2 active" data-value="addcolumn">Add Column</button>
                                <button type="button" class="switch-btn2" data-value="removecolumn">Remove Column</button>
                                <button type="button" class="switch-btn2" data-value="changecolumnname">Column Name</button>
                                <button type="button" class="switch-btn2" data-value="changecolumntype">Column Type</button>
                                <button type="button" class="switch-btn2" data-value="changecolumnconstraints">Column Constraints</button>
                                <button type="button" class="switch-btn2" data-value="customchange">Custom Schema Change</button>

                                <input type="hidden" name="changeschemaType" id="changeschemaType" value="addcolumn">
                            </div>
                        </div>

                        <div id="changeschemaDetails">
                            <div class="popup-field">
                                <div class="popup-label" id="changeschema-header">
                                    Add Column(s) &nbsp;
                                    <button type="button" onclick="add_changeschema_column(1)">+</button>                                            
                                </div>
                                <div id="changeschemacontents">
                                    <table id="changeschemacontents-table">
                                        <tr>
                                            <th>Column Select</th>
                                            <th>Column Name</th>
                                            <th>Column Type</th>
                                            <th>Column Constraint</th>
                                        </tr>
                                        <tr data-index="0">
                                            <td><button type="button" class="spare-button" onclick="remove_changeschema_column(0)">-</button></td>
                                            <td><input type="text" name="columnname1"></td>    
                                            <td class="column-type-div">
                                                <select name="columntype1" class="column-type">
                                                    <option value="int">Int</option>
                                                    <option value="float">Float</option>
                                                    <option value="string">String</option>                                                            
                                                    <option value="derivative">Derivative</option>    
                                                </select>  
                                                        
                                                    <input
                                                        type="text"
                                                        name="derivativeinfo1"
                                                        class="derivative-input"
                                                        placeholder="Formula / logic"
                                                        style="display:none; margin-top:4px;"
                                                        value=""
                                                    >
                                            </td>
                                            <td class="constraints">
                                                    <input type="checkbox" name="notnull1">&nbsp;
                                                    <label for="notnull1">Not Null</label>&nbsp;

                                                    <input type="checkbox" name="primarykey1">&nbsp;
                                                    <label for="primarykey1">Primary Key</label>&nbsp;

                                                    <input type="checkbox" name="unique1">&nbsp;
                                                    <label for="unique1">Unique</label>&nbsp;

                                                    <input type="checkbox" name="serial1">&nbsp;
                                                    <label for="serial1">Serial</label>
                                            </td>
                                        </tr>    
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Change</button>
                    </div>
                </form>
                <script>
                    const changeschemaBtns = document.querySelectorAll('.switch-btn2');
                    const changeschemaTypeInput = document.getElementById('changeschemaType');
                    const changeschemaDetails =  document.getElementById('changeschemaDetails');
                    changeschemaBtns.forEach(btn => {
                        btn.addEventListener('click', () => {

                            // switch active button
                            changeschemaBtns.forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');

                            // set hidden input
                            const type = btn.dataset.value;
                            changeschemaTypeInput.value = type;

                            let detailHtml = '';

                            if (type === 'addcolumn'){
                                detailHtml += `
                                    <div class="popup-field">
                                        <div class="popup-label" id="changeschema-header">
                                            Add Column(s) &nbsp;
                                            <div>
                                                <button type="button" onclick="add_changeschema_column(1)">+</button>
                                            </div>
                                        </div>
                                        <div id="changeschemacontents">
                                            <table id="changeschemacontents-table">
                                                <tr>
                                                    <th>Column Select</th>
                                                    <th>Column Name</th>
                                                    <th>Column Type</th>
                                                    <th>Column Constraint</th>
                                                </tr>
                                                <tr data-index="0">
                                                    <td><button type="button" class="spare-button" onclick="remove_changeschema_column(0)">-</button></td>
                                                    <td><input type="text" name="columnname1"></td>    
                                                    <td class="column-type-div">
                                                        <select name="columntype1" class="column-type">
                                                            <option value="int">Int</option>
                                                            <option value="float">Float</option>
                                                            <option value="string">String</option> 
                                                            <option value="derivative">Derivative</option>    
                                                        </select>  
                                                        
                                                        <input
                                                            type="text"
                                                            name="derivativeinfo1"
                                                            class="derivative-input"
                                                            placeholder="Formula / logic"
                                                            style="display:none; margin-top:4px;"
                                                            value=""
                                                        >
                                                    </td>
                                                    <td class="constraints">
                                                        <input type="checkbox" name="notnull1">&nbsp;
                                                        <label for="notnull1">Not Null</label>&nbsp;

                                                        <input type="checkbox" name="primarykey1">&nbsp;
                                                        <label for="primarykey1">Primary Key</label>&nbsp;

                                                        <input type="checkbox" name="unique1">&nbsp;
                                                        <label for="unique1">Unique</label>&nbsp;

                                                        <input type="checkbox" name="serial1">&nbsp;
                                                        <label for="serial1">Serial</label>
                                                    </td>
                                                </tr>    
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }
                            else if (type === 'removecolumn'){
                                detailHtml += `
                                    <div class="popup-field">
                                        <div class="popup-label">Select Column(s)</div>
                                        <div class="popup-checkboxes background-1" style="margin-top: 5px;">
                                            <div>
                                                <input type="checkbox" name="allcolumns" value="*">
                                                <label for="allcolumns" class="popup-label">All Columns</label>
                                            </div>

                                            <% for (let i = 0; i<extra_data.data.columns.length; i++) { %>
                                                <div>
                                                    <input type="checkbox" name="column<%= i+1%>" value="<%= extra_data.data.columns[i].name%>">
                                                    <label for="column<%= i+1%>" class="popup-label"><%= extra_data.data.columns[i].name%></label>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                `;
                            }
                            else if (type === 'changecolumnname'){
                                let j=1;
                                detailHtml=`
                                    <div class="popup-field">
                                        <div class="popup-label">Edit Column Name(s)</div>
                                        <div style="display:flex; gap:5px;" class="background-1">
                                            <% for (let i=0; i<extra_data.data.columns.length; i++){ %>
                                                <input name="column${j++}" class="popup-input" value="<%=extra_data.data.columns[i].name%>" required />
                                            <%}%>
                                        </div>
                                    </div>
                                `;
                            }
                            else if (type === 'changecolumntype'){
                                let j=1;
                                detailHtml=`
                                <div class="popup-field">
                                        <div class="popup-label">Edit Column Type(s)</div>
                                        <div class="background-1" style="display:flex; gap:5px; flex-direction: column;">
                                            <% for (let i=0; i<extra_data.data.columns.length; i++){ %>
                                                <div style="display: grid; grid-template-columns: 0.35fr 0.35fr 0.30fr; align-items: center;">
                                                    <label class="popup-label" for="column${j}"><%=extra_data.data.columns[i].name%></label>

                                                    <select name="column${j++}" class="popup-input column-type2" style="width: 80%;">
                                                        <option value="int" <%= extra_data.data.columns[i].type === 'int' ? 'selected' : ''%>>Int</option>
                                                        <option value="float"<%= extra_data.data.columns[i].type === 'float' ? 'selected' : ''%>>Float</option>
                                                        <option value="string"<%= extra_data.data.columns[i].type === 'string' ? 'selected' : ''%>>String</option> 
                                                        <option value="derivative"<%= extra_data.data.columns[i].type === 'derivative' ? 'selected' : ''%>>Derivative</option>  
                                                    </select>

                                                    <input
                                                            
                                                            type="text"
                                                            name="derivativeinfo<%=i+1%>"
                                                            class="popup-input derivative-input2 "
                                                            placeholder="Formula / logic"
                                                            <%if (extra_data.data.columns[i].type === 'derivative'){ %>
                                                                style = "margin-top: 4px; display: block"
                                                            <%}else{%>
                                                                style = "margin-top: 4px; display: none"
                                                            <%}%>
                                                            value="<%=extra_data.data.columns[i].expression%>"
                                                    >
                                                </div>
                                            <%}%>
                                        </div>
                                    </div>
                                `;
                            }
                            else if (type === 'changecolumnconstraints'){
                                let j=1;
                                detailHtml=`
                                <div class="popup-field">
                                        <div class="popup-label">Edit Column Constraint(s)</div>
                                        <div class="background-1" style="display:flex; gap:5px; flex-direction: column;">
                                            <% for (let i=0; i<extra_data.data.columns.length; i++){ %>
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <label class="popup-label" for="column${j}"><%=extra_data.data.columns[i].name%></label>

                                                    <div  class="spare-constraints" style="gap:5px;">
                                                        <input type="checkbox" name="notnull${j}" <%= extra_data.data.columns[i].constraints.includes('not_null') ? 'checked' : ''%>>&nbsp;
                                                        <label for="notnull${j}">Not Null</label>&nbsp;

                                                        <input type="checkbox" name="primarykey${j}" <%= extra_data.data.columns[i].constraints.includes('primary_key') ? 'checked' : ''%>>&nbsp;
                                                        <label for="primarykey${j}">Primary Key</label>&nbsp;

                                                        <input type="checkbox" name="unique${j}" <%= extra_data.data.columns[i].constraints.includes('unique') ? 'checked' : ''%>>&nbsp;
                                                        <label for="unique${j}">Unique</label>&nbsp;

                                                        <input type="checkbox" name="serial${j}" <%= extra_data.data.columns[i].constraints.includes('serial') ? 'checked' : ''%>>&nbsp;
                                                        <label for="serial${j++}">Serial</label>
                                                    </div>
                                                </div>
                                            <%}%>
                                        </div>
                                    </div>
                                `;
                            }
                            else if (type === 'customchange'){
                                detailHtml=`
                                    <div class="popup-field">
                                        <div class="popup-label" id="changeschema-header">
                                            Modify Column(s) &nbsp;
                                            <div>
                                                <button type="button" onclick="add_changeschema_column()">+</button>
                                                <button type="button" onclick="remove_changeschema_column()">-</button>
                                            </div>
                                        </div>
                                        <div id="changeschemacontents">
                                            <table id="changeschemacontents-table">
                                                <tr>
                                                    <th>Column Select</th>
                                                    <th>Column Name</th>
                                                    <th>Column Type</th>
                                                    <th>Column Constraint</th>
                                                </tr>
                                                <%for (let i=0; i<extra_data.data.columns.length; i++){%>
                                                <tr data-index="<%=i%>">
                                                        <td><button type="button" class="spare-button" onclick="remove_changeschema_column(<%=i%>)">-</button></td>
                                                        <td><input type="text" name="columnname<%=i+1%>" value="<%= extra_data.data.columns[i].name%>"></td>    
                                                        <td class="column-type-div">
                                                            <select name="columntype<%=i+1%>" class="column-type">
                                                                <option value="int" <%= extra_data.data.columns[i].type === 'int' ? 'selected' : ''%>>Int</option>
                                                                <option value="float"<%= extra_data.data.columns[i].type === 'float' ? 'selected' : ''%>>Float</option>
                                                                <option value="string"<%= extra_data.data.columns[i].type === 'string' ? 'selected' : ''%>>String</option> 
                                                                <option value="derivative"<%= extra_data.data.columns[i].type === 'derivative' ? 'selected' : ''%>>Derivative</option>    
                                                            </select>  
                                                            
                                                            <input
                                                                type="text"
                                                                name="derivativeinfo<%=i+1%>"
                                                                class="derivative-input"
                                                                placeholder="Formula / logic"
                                                                style=<%= extra_data.data.columns[i].type === 'derivative' ? ' margin-top:4px;' : 'display:none;'%>
                                                                value="<%=extra_data.data.columns[i].expression%>"
                                                            >
                                                        </td>
                                                        <td class="constraints">
                                                            <input type="checkbox" name="notnull<%=i+1%>" <%= extra_data.data.columns[i].type === 'derivative' ? 'disabled' : extra_data.data.columns[i].constraints.includes('not_null') ? 'checked' : ''%>>&nbsp;
                                                            <label for="notnull<%=i+1%>">Not Null</label>&nbsp;

                                                            <input type="checkbox" name="primarykey<%=i+1%>" <%= extra_data.data.columns[i].type === 'derivative' ? 'disabled' : extra_data.data.columns[i].constraints.includes('primary_key') ? 'checked' : ''%>>&nbsp;
                                                            <label for="primarykey<%=i+1%>">Primary Key</label>&nbsp;

                                                            <input type="checkbox" name="unique<%=i+1%>" <%= extra_data.data.columns[i].type === 'derivative' ? 'disabled' : extra_data.data.columns[i].constraints.includes('unique') ? 'checked' : ''%>>&nbsp;
                                                            <label for="unique<%=i+1%>">Unique</label>&nbsp;

                                                            <input type="checkbox" name="serial<%=i+1%>" <%= extra_data.data.columns[i].type === 'derivative' ? 'disabled' : extra_data.data.columns[i].constraints.includes('serial') ? 'checked' : ''%>>&nbsp;
                                                            <label for="serial<%=i+1%>">Serial</label>
                                                        </td>
                                                </tr>  
                                                <%}%>
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            changeschemaDetails.innerHTML = detailHtml;
                        });
                    });

                    const changeschema_data = <%- JSON.stringify(extra_data.data.columns)%>;
                    let customchangeschema_column_count = changeschema_data.length;
                    let addcolumnchangeschema_column_count = 1;

                    function add_changeschema_column(number){
                        let column_number;
                        if (number === 1){
                            column_number = ++addcolumnchangeschema_column_count;
                        }
                        else{
                            column_number = ++customchangeschema_column_count;
                        }

                        document.querySelector('#changeschemacontents-table').innerHTML +=`
                        <tr data-index="${column_number-1}">
                            <td><button type="button" class="spare-button" onclick="remove_changeschema_column(${column_number-1})">-</button></td>
                            <td><input type="text" name="columnname${column_number}"></td>
                            <td>
                                <select name="columntype${column_number}" class="column-type">
                                    <option value="int">Int</option>
                                    <option value="float">Float</option>
                                    <option value="string">String</option>    
                                    <option value="derivative">Derivative</option> 
                                </select>

                                <input
                                    type="text"
                                    name="derivativeinfo${column_number}"
                                    class="derivative-input"
                                    placeholder="Formula / logic"
                                    style="display:none; margin-top:4px;"
                                >
                            </td>
                            <td class="constraints">
                                <input type="checkbox" name="notnull${column_number}">&nbsp;
                                <label for="notnull${column_number}">Not Null</label>&nbsp;

                                <input type="checkbox" name="primarykey${column_number}">&nbsp;
                                <label for="primarykey${column_number}">Primary Key</label>&nbsp;

                                <input type="checkbox" name="unique${column_number}">&nbsp;
                                <label for="unique${column_number}">Unique</label>&nbsp;

                                <input type="checkbox" name="serial${column_number}">&nbsp;
                                <label for="serial${column_number}">Serial</label>
                            </td>
                        </tr>
                    `;
                    }

                    function reindexRows() {
                        document
                            .querySelectorAll('#changeschemacontents-table tr[data-index]')
                            .forEach((row, i) => {
                            row.dataset.index = i;

                            const btn = row.querySelector('.spare-button');
                            if (btn) btn.onclick = () => remove_changeschema_column(i);
                            });
                        }


                    function remove_changeschema_column(index = -1) {
                        const table = document.querySelector('#changeschemacontents-table');

                        if (table.rows.length <= 1) return;

                        if (index !== -1) {
                            const row = table.querySelector(`tr[data-index="${index}"]`);
                            if (row) row.remove();
                        } else {
                            table.deleteRow(-1);
                        }

                        reindexRows(); // üî• critical
                        }

                    
                    document.addEventListener('change', function (e) {
                        if (!e.target.name.startsWith('primarykey')) return;

                        if (e.target.checked) {
                            document
                                .querySelectorAll('input[name^="primarykey"]')
                                .forEach(cb => {
                                    if (cb !== e.target) cb.checked = false;
                                });
                        }
                    });

                    document.addEventListener('change', function(e){
                        if (!e.target.classList.contains('column-type2')) return;
                        const d_input = e.target.parentElement.querySelector('.derivative-input2');
                        console.log(e.target.value)
                        if (e.target.value === 'derivative'){
                            d_input.style.display='block';
                        }
                        else{
                            d_input.style.display='none';
                            d_input.value='';
                        }
                    });

                    document.addEventListener('change', function (e) {
                    if (!e.target.classList.contains('column-type')) return;

                        const typeCell = e.target.closest('td');
                        const row = e.target.closest('tr');

                        const derivativeInput = typeCell.querySelector('.derivative-input');
                        const constraintsCell = row.querySelector('.constraints');

                        if (!derivativeInput || !constraintsCell) return;

                        const constraintInputs = constraintsCell.querySelectorAll('input');

                        if (e.target.value === 'derivative') {
                            derivativeInput.style.display = 'block';

                            constraintInputs.forEach(i => {
                            i.checked = false;
                            i.disabled = true;
                            });

                        } else {
                            derivativeInput.style.display = 'none';
                            derivativeInput.value = '';

                            constraintInputs.forEach(i => {
                            i.disabled = false;
                            });
                        }
                    });
                </script>
            <%}%>

            <%if (message1 === 'find'){ %>
                <form action="/find" class="popup-card" method="POST">

                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Find</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">

                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Locate</div>
                            <div class="chart-switch">
                                <button type="button" class="switch-btn active" data-value="key">Key</button>
                                <button type="button" class="switch-btn" data-value="value">Value</button>

                                <input type="hidden" name="findType" id="findType" value="key">
                            </div>
                        </div>

                        <div id="find-details">
                            <div class="popup-field">
                                <div class="popup-label">Key Name</div>
                                <input name="keyname" class="popup-input" required />
                            </div>
                                
                            <div class="popup-field">
                                <div class="popup-label">Match Case</div>
                                <select name="matchtype" class="popup-input">
                                    <option value="exact">Exact Match</option>
                                    <option value="partial">Partial Match</option>
                                    <option value="caseinsensitive">Case-Insensitive</option>    
                                </select>
                            </div>
                        </div>

                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Find</button>
                    </div>

                </form>
                <script>
                    const findBtns = document.querySelectorAll('.switch-btn');
                    const findTypeInput = document.getElementById('findType');
                    const findDetails =  document.getElementById('find-details');
                    findBtns.forEach(btn => {
                        btn.addEventListener('click', () => {

                            // switch active button
                            findBtns.forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');

                            // set hidden input
                            const type = btn.dataset.value;
                            findTypeInput.value = type;

                            let detailHtml = '';
                            if (type === 'key'){
                                detailHtml += `
                                <div class="popup-field">
                                    <div class="popup-label">Key Name</div>
                                    <input name="keyname" class="popup-input" required />
                                </div>

                                <div class="popup-field">
                                    <div class="popup-label">Match Case</div>
                                    <select name="matchtype" class="popup-input">
                                        <option value="exact">Exact Match</option>
                                        <option value="partial">Partial Match</option>
                                        <option value="caseinsensitive">Case-Insensitive</option>    
                                    </select>
                                </div>
                                `;
                            }
                            else if (type === 'value'){
                                detailHtml += `
                                    <div class="popup-field">
                                        <div class="popup-label">Value Name</div>
                                        <input name="valuename" class="popup-input" required />
                                    </div>

                                    <div class="popup-field">
                                        <div class="popup-label">Value Type</div>
                                        <select name="valuetype" class="popup-input" id="value-type">
                                            <option value="string">String</option>
                                            <option value="number">Number</option>
                                            <option value="boolean">Boolean</option>    
                                        </select>
                                    </div>

                                    <div class="popup-field">
                                        <div class="popup-label">Operator</div>
                                        <select name="operator" class="popup-input" id="operator-select">
                                            <option value="equals">=</option>
                                            <option value="contains">CONTAINS</option>   
                                        </select>
                                    </div>
                                `;
                            }

                            findDetails.innerHTML = detailHtml;
                        });
                    });
                
                    document.addEventListener('change', (e) => {
                                if (e.target.id !== 'value-type') return;

                                const valueTypeSelect = e.target;
                                const operatorSelect = document.querySelector('#operator-select');

                                let operatorHtml = '';

                                if (valueTypeSelect.value === 'string'){
                                    operatorHtml += `
                                        <option value="equals">=</option>
                                        <option value="contains">CONTAINS</option>
                                    `;
                                }
                                else if (valueTypeSelect.value === 'number'){
                                    operatorHtml += `
                                        <option value="equals">=</option>
                                        <option value="notequals">!=</option>
                                        <option value="lessthan"><</option>
                                        <option value="morethan">></option>
                                        <option value="lessthanequals"><=</option>
                                        <option value="morethanequals">>=</option>
                                    `;
                                }
                                else if (valueTypeSelect.value === 'boolean'){
                                    operatorHtml += `
                                        <option value="equals">=</option>
                                    `;
                                }
                                operatorSelect.innerHTML = operatorHtml;
                            });
                            
                </script>
            <%}%>
            <% if (message1 === 'visualizedataresult') { %>
                <div class="popup-card ">
                    <div class="popup-header popup-drag-handle">
                        <span>Data Grid</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body analytics-dashboard" id="analytics-dashboard">
                        <!-- Header -->
                        <div class="analytics-header">
                            <h2>üìà Data Analytics Studio</h2>
                            <span class="analytics-subtitle">Advanced insights & visual intelligence</span>
                        </div>

                        <!-- Tabs -->
                        <div class="analytics-tabs">
                            <button class="tab-btn active" data-tab="overview">Overview</button>
                            <button class="tab-btn" data-tab="visual">Visualization</button>
                            <button class="tab-btn" data-tab="statistics">Statistics</button>
                            <button class="tab-btn" data-tab="distribution">Distribution</button>
                            <button class="tab-btn" data-tab="table">Raw Data</button>
                        </div>

                        <div class="tab-content active" id="tab-overview">

                            <!-- SECTION 1: DATASET SNAPSHOT -->
                            <div class="overview-section">
                                <h3>üìä Dataset Snapshot</h3>
                                <div class="kpi-grid" id="snapshotKPIs"></div>
                            </div>

                            <!-- SECTION 2: AGGREGATED METRICS -->
                            <div class="overview-section">
                                <h3>üìê Aggregated Metrics (<%= extra_data.data.valueY %>)</h3>
                                <div class="kpi-grid" id="aggregateKPIs"></div>
                            </div>

                            <!-- SECTION 3: AI INSIGHTS -->
                            <div class="overview-section">
                                <h3>üß† AI Insights</h3>
                                <div class="ai-grid" id="aiInsightsGrid"></div>
                            </div>

                            <!-- SECTION 4: ACTIONABLE INTELLIGENCE -->
                            <div class="overview-section">
                                <h3>üéØ Actionable Intelligence</h3>
                                <div class="ai-actions" id="aiActions"></div>
                            </div>

                        </div>


                        <!-- TAB: VISUAL -->
                        <div class="tab-content" id="tab-visual">
                            <button class="download-btn" onclick="downloadChartInstance(mainChart, 'main-chart.png')">
                                ‚¨á Download Chart (PNG)
                            </button>
                            <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                            </div>
                        </div>

                        <!-- TAB: STATISTICS -->
                        <div class="tab-content" id="tab-statistics">

                            <div class="overview-section"><h3>üìä Column Statistics</h3></div>
                            <div class="stats-grid" id="statsCards"></div>

                            <div class="overview-section"><h3>üìê Distribution & Percentiles</h3></div>
                            <div class="stats-grid" id="distributionCards"></div>

                            <div class="overview-section"><h3>‚ö†Ô∏è Outlier Detection</h3></div>
                            <div class="outlier-box" id="outlierList"></div>

                            <div class="overview-section"><h3>üß© Column Insights</h3></div>
                            <div class="column-insights" id="columnInsights"></div>

                            <div class="overview-section"><h3>üß™ Data Quality</h3></div>
                            <div class="quality-card" id="dataQuality"></div>

                        </div>


                        <!-- TAB: DISTRIBUTION -->
                        <div class="tab-content" id="tab-distribution">
                            <button class="download-btn" onclick="downloadChartInstance(distChart, 'distribution.png')">
                                ‚¨á Download Distribution (PNG)
                            </button>
                            <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                            </div>
                        </div>

                        <!-- TAB: TABLE -->
                        <div class="tab-content" id="tab-table">
                            <div class="table-visualization-wrapper">
                            <table id="dataTable"></table>
                            </div>
                        </div>

                        </div>


                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">End</button>
                    </div>
                </div>
                <script>
                /* ---------------- DATA ---------------- */
                const rows = <%- JSON.stringify(extra_data.data.rows) %>;
                const columns = <%- JSON.stringify(extra_data.data.columns) %>;

                const chartType = "<%= extra_data.data.chartType %>";
                const categoryX = "<%= extra_data.data.categoryX %>";
                const valueY = "<%= extra_data.data.valueY %>";
                const groupBy = "<%= extra_data.data.groupBy %>";

                const aiText = <%- JSON.stringify(extra_data.data.aidata || '') %>;
                const cleanAIText = aiText
                .replace(/```[\s\S]*?```/g, '')   // remove code blocks
                .replace(/`/g, ''); 

                let mainChart, distChart;

                /* ---------------- HELPERS ---------------- */
                function isNumber(val) {
                return typeof val === 'number' && !isNaN(val);
                }

                function downloadChartInstance(chartInstance, filename = 'chart.png') {
                    if (!chartInstance) {
                        alert('Chart not ready yet');
                        return;
                    }

                    const link = document.createElement('a');
                    link.href = chartInstance.toBase64Image(); // ‚úÖ Chart.js API
                    link.download = filename;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }


                /* GROUP + AGGREGATE */
                function aggregateData() {
                const map = {};

                rows.forEach(r => {
                    const x = r[categoryX];
                    const group = groupBy ? r[groupBy] : 'ALL';

                    if (!map[group]) map[group] = {};
                    if (!map[group][x]) map[group][x] = [];

                    map[group][x].push(Number(r[valueY]));
                });

                return map;
                }

                /* ---------------- KPI ENGINE ---------------- */
                function renderSnapshot() {
                    const snapshot = [
                        { title: 'Rows', value: rows.length },
                        { title: 'Columns', value: columns.length },
                        { title: 'X Axis', value: categoryX },
                        { title: 'Y Axis', value: valueY },
                        { title: 'Grouped By', value: groupBy || 'None' }
                    ];

                    document.getElementById('snapshotKPIs').innerHTML =
                        snapshot.map(k => `
                        <div class="kpi-card">
                            <div class="kpi-title">${k.title}</div>
                            <div class="kpi-value">${k.value}</div>
                        </div>
                        `).join('');
                    }
                
                function renderAggregates() {
                    const nums = rows.map(r => Number(r[valueY])).filter(isNumber);
                    const mean = nums.reduce((a,b)=>a+b,0)/nums.length;
                    const variance = nums.reduce((a,b)=>a+(b-mean)**2,0)/nums.length;

                    const aggs = [
                        { title:'Sum', value: nums.reduce((a,b)=>a+b,0).toFixed(2) },
                        { title:'Average', value: mean.toFixed(2) },
                        { title:'Min', value: Math.min(...nums) },
                        { title:'Max', value: Math.max(...nums) },
                        { title:'Variance', value: variance.toFixed(2) }
                    ];

                    document.getElementById('aggregateKPIs').innerHTML =
                        aggs.map(k => `
                        <div class="kpi-card">
                            <div class="kpi-title">${k.title}</div>
                            <div class="kpi-value">${k.value}</div>
                        </div>
                        `).join('');
                    }

                function parseAISections(text) {
                    const blocks = {};
                    const markers = ['KEY_TRENDS','ANOMALIES','PREDICTIONS','RECOMMENDATIONS'];

                    markers.forEach((m, i) => {
                        const start = text.indexOf(`[${m}]`);
                        if (start === -1) return;

                        const end = markers
                        .slice(i+1)
                        .map(n => text.indexOf(`[${n}]`))
                        .filter(p => p !== -1)
                        .sort((a,b)=>a-b)[0];

                        blocks[m] = text
                        .substring(start + m.length + 2, end || undefined)
                        .trim();
                    });

                    return blocks;
                    }


                function renderAIInsights() {
                    const sections = parseAISections(cleanAIText);

                    const bullets = txt =>
                        (txt || '')
                        .split('\n')
                        .filter(l => l.trim().startsWith('*'))
                        .map(l => `<p>${l.replace(/^\*\s*/, '')}</p>`)
                        .join('') || '<p>‚Äî</p>';

                    document.getElementById('aiInsightsGrid').innerHTML = `
                        <div class="ai-card">
                        <h4>üìà Key Trends</h4>
                        ${bullets(sections.KEY_TRENDS)}
                        </div>
                        <div class="ai-card">
                        <h4>‚ö†Ô∏è Anomalies</h4>
                        ${bullets(sections.ANOMALIES)}
                        </div>
                    `;

                    document.getElementById('aiActions').innerHTML = `
                        <h4>üîÆ Predictions</h4>
                        ${bullets(sections.PREDICTIONS)}
                        <br/>
                        <h4>üéØ Recommendations</h4>
                        ${bullets(sections.RECOMMENDATIONS)}
                    `;
                    }

                function renderStatisticsTab() {
                    const statsRoot = document.getElementById('tab-statistics');
                    if (!statsRoot) return;

                    const isNumber = v => typeof v === 'number' && !isNaN(v);

                    const mean = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
                    const variance = a => {
                        if (!a.length) return 0;
                        const m = mean(a);
                        return mean(a.map(x => (x - m) ** 2));
                    };
                    const stdDev = a => Math.sqrt(variance(a));
                    const percentile = (a,p) => {
                        if (!a.length) return 0;
                        const s = [...a].sort((x,y)=>x-y);
                        return s[Math.floor(p * (s.length - 1))];
                    };

                    let statsHTML = '';
                    let distHTML = '';
                    let outlierHTML = '';
                    let insightHTML = '';

                    let qualityScore = 100;

                    columns.forEach(col => {
                        const values = rows.map(r => r[col.name]).filter(isNumber);
                        if (!values.length) return;

                        const m = mean(values);
                        const sd = stdDev(values);
                        const min = Math.min(...values);
                        const max = Math.max(...values);

                        const p10 = percentile(values,0.1);
                        const p50 = percentile(values,0.5);
                        const p90 = percentile(values,0.9);

                        const cv = m ? (sd / m) * 100 : 0;
                        if (cv > 80) qualityScore -= 10;

                        /* ---- STAT CARD ---- */
                        statsHTML += `
                        <div class="stat-card">
                            <h4>${col.name}</h4>
                            <div class="stat-row"><div class="kpi-title">Mean </div><b>${m.toFixed(2)}</b></div>
                            <div class="stat-row"><div class="kpi-title">Std Dev </div><b>${sd.toFixed(2)}</b></div>
                            <div class="stat-row"><div class="kpi-title">Min </div><b>${min}</b></div>
                            <div class="stat-row"><div class="kpi-title">Max </div><b>${max}</b></div>
                        </div>
                        `;

                        /* ---- DISTRIBUTION ---- */
                        distHTML += `
                        <div class="stat-card soft">
                            <h4>${col.name}</h4>
                            <div class="stat-row"><div class="kpi-title">P10: </div><b>${p10.toFixed(2)}</b></div>
                            <div class="stat-row"><div class="kpi-title">P50: </div><b>${p50.toFixed(2)}</b></div>
                            <div class="stat-row"><div class="kpi-title">P90: </div><b>${p90.toFixed(2)}</b></div>
                        </div>
                        `;

                        /* ---- OUTLIERS (IQR) ---- */
                        const q1 = percentile(values,0.25);
                        const q3 = percentile(values,0.75);
                        const iqr = q3 - q1;
                        const low = q1 - 1.5 * iqr;
                        const high = q3 + 1.5 * iqr;

                        rows.forEach(r => {
                        const v = r[col.name];
                        if (isNumber(v) && (v < low || v > high)) {
                            outlierHTML += `
                            <div class="outlier-item">
                                ${col.name}: <b>${v}</b> (Row ${r.ID})
                            </div>
                            `;
                        }
                        });

                        /* ---- INSIGHT ---- */
                        insightHTML += `
                        <div class="insight-card">
                            <h4>${col.name}</h4>
                            <p>
                            Numeric column with <b>${cv.toFixed(1)}%</b> variability.
                            ${cv > 70 ? 'High dispersion.' : 'Stable distribution.'}
                            </p>
                        </div>
                        `;
                    });

                    document.getElementById('statsCards').innerHTML = statsHTML || '<p>‚Äî</p>';
                    document.getElementById('distributionCards').innerHTML = distHTML || '<p>‚Äî</p>';
                    document.getElementById('outlierList').innerHTML = outlierHTML || '<p>No significant outliers</p>';
                    document.getElementById('columnInsights').innerHTML = insightHTML || '<p>‚Äî</p>';

                    document.getElementById('dataQuality').innerHTML = `
                        <div class="quality-score ${qualityScore < 70 ? 'bad' : 'good'}">
                        ${qualityScore} / 100
                        </div>
                    `;
                    }

                /* ---------------- MAIN CHART ---------------- */
                
                function renderChart() {
                    const ctx = document.getElementById('mainChart');
                    if (!ctx) return;

                    if (mainChart) mainChart.destroy();

                    /* ---------- PIE / DOUGHNUT ---------- */
                    if (chartType === 'pie' || chartType === 'doughnut') {
                        const counts = {};

                        rows.forEach(r => {
                        const key = categoryX ? r[categoryX] : r[groupBy];
                        counts[key] = (counts[key] || 0) + 1;
                        });

                        mainChart = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                            data: Object.values(counts)
                            }]
                        },
                        options: { responsive: true }
                        });

                        return;
                    }

                    /* ---------- BAR / LINE ---------- */
                    const labels = [...new Set(rows.map(r => r[categoryX]))];
                    const groups = groupBy ? [...new Set(rows.map(r => r[groupBy]))] : ['ALL'];

                    // Pre-index data (üî• critical fix)
                    const map = {};
                    rows.forEach(r => {
                        const x = r[categoryX];
                        const g = groupBy ? r[groupBy] : 'ALL';
                        if (!map[g]) map[g] = {};
                        map[g][x] = Number(r[valueY]);
                    });

                    const datasets = groups.map(g => ({
                        label: g,
                        data: labels.map(l => map[g]?.[l] ?? 0),
                        borderWidth: 2,
                        tension: chartType === 'line' ? 0.3 : 0,
                        fill: false
                    }));

                    mainChart = new Chart(ctx, {
                        type: chartType,
                        data: { labels, datasets },
                        options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                        }
                    });
                }


                /* ---------------- DISTRIBUTION ---------------- */
                function renderDistribution() {
                const nums = rows.map(r => Number(r[valueY])).filter(isNumber);

                distChart?.destroy();
                distChart = new Chart(document.getElementById('distributionChart'), {
                    type: 'line',
                    data: {
                    labels: nums.map((_,i)=>i+1),
                    datasets: [{
                        label: 'Distribution',
                        data: nums.sort((a,b)=>a-b),
                        borderWidth: 2
                    }]
                    }
                });
                }

                /* ---------------- TABLE ---------------- */
                function renderTable() {
                const table = document.getElementById('dataTable');
                table.innerHTML = `
                    <thead>
                    <tr>${columns.map(c=>`<th>${c.name}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                    ${rows.map(r=>`
                        <tr>${columns.map(c=>`<td>${r[c.name]}</td>`).join('')}</tr>
                    `).join('')}
                    </tbody>
                `;
                }

                /* ---------------- TABS ---------------- */
                document.querySelectorAll('.tab-btn').forEach(btn=>{
                btn.onclick = ()=>{
                    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
                }
                });

                /* ---------------- INIT ---------------- */
                renderSnapshot();
                renderStatisticsTab()
                renderAggregates();
                renderAIInsights();
                renderTable();
                

                setTimeout(() => {
                renderChart();
                renderDistribution();
                }, 50);
                </script>
            <%}%>

            <% if (message1 === 'visualizedata'){ %>
                <form action="/visualizedata" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>üìä Visualize Data</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%=  filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Chart Type</div>
                            <div class="chart-switch">
                                <button type="button" class="switch-btn active" data-value="bar">Bar</button>
                                <button type="button" class="switch-btn" data-value="line">Line</button>
                                <button type="button" class="switch-btn" data-value="pie">Pie</button>

                                <input type="hidden" name="chartType" id="chartType" value="bar">
                            </div>
                        </div>

                        <div class="popup-field checkboxes-div" style="margin-top: 5px;">
                            <div class="popup-label">Data Mapping</div>
                            
                            <div class="visualize-select-row">
                                <div class="popup-label">Category (X): </div>
                                <select name="category_x" id="" class="popup-input">
                                    <% for (let i=0; i<extra_data.data.columns.length; i++){ %>
                                        <option value="<%= extra_data.data.columns[i].name%>"><%= extra_data.data.columns[i].name%></option>
                                    <% } %>
                                </select>
                            </div>

                            <div class="visualize-select-row" id="value_y">
                                <div class="popup-label">Value (Y): </div>
                                <select name="value_y" id="" class="popup-input">
                                    <% for (let i=0; i<extra_data.data.columns.length; i++){ if(extra_data.data.columns[i].type==='int' || extra_data.data.columns[i].type==='float'){%>
                                        <option value="<%= extra_data.data.columns[i].name%>"><%= extra_data.data.columns[i].name%></option>
                                    <% }} %>
                                </select>
                            </div>

                                <div class="visualize-select-row" id="groupByRow">
                                    <div class="popup-label">Group By:</div>
                                    <select name="group_by" class="popup-input">
                                        <% for (let i=0; i<extra_data.data.columns.length; i++){ %>
                                            <option value="<%= extra_data.data.columns[i].name %>">
                                                <%= extra_data.data.columns[i].name %>
                                            </option>
                                        <% } %>
                                    </select>
                                </div>

                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Live Preview</div>
                            <canvas id="chartPreview" height="200"></canvas>
                        </div>
                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Generate</button>
                    </div>
                </form>
                 <script>
                    const tableRows = <%- JSON.stringify(extra_data.data.rows) %>;
                    let chart;

                    function renderChart() {
                        const type = document.getElementById('chartType').value;
                        const xKey = document.querySelector('[name="category_x"]').value;
                        const yKey = document.querySelector('[name="value_y"]').value;
                        const groupByEl = document.querySelector('[name="group_by"]');
                        const groupBy = groupByEl && groupByEl.style.display !== 'none'
                            ? groupByEl.value
                            : null;

                        if (chart) chart.destroy();

                        /* ---------------- PIE ---------------- */
                        if (type === 'pie') {
                            const map = {};

                            tableRows.forEach(row => {
                                const label = row[xKey];
                                map[label] = (map[label] || 0) + 1;
                            });

                            chart = new Chart(chartPreview, {
                                type: 'pie',
                                data: {
                                    labels: Object.keys(map),
                                    datasets: [{
                                        data: Object.values(map),
                                        backgroundColor: Object.keys(map).map(
                                            (_, i) => `hsl(${i * 60},70%,60%)`
                                        )
                                    }]
                                }
                            });
                            return;
                        }

                        /* -------- BAR / LINE WITH GROUP BY -------- */

                        const xLabels = [...new Set(tableRows.map(r => r[xKey]))];
                        const groupedData = {};

                        tableRows.forEach(row => {
                            const x = row[xKey];
                            const y = Number(row[yKey]) || 0;
                            const g = groupBy ? row[groupBy] : 'All';

                            if (!groupedData[g]) groupedData[g] = {};
                            groupedData[g][x] = (groupedData[g][x] || 0) + y;
                        });

                        const datasets = Object.keys(groupedData).map((group, idx) => ({
                            label: groupBy ? `${groupBy}: ${group}` : yKey,
                            data: xLabels.map(x => groupedData[group][x] || 0),
                            backgroundColor: `hsl(${idx * 60},70%,60%)`,
                            borderColor: `hsl(${idx * 60},70%,45%)`,
                            fill: type === 'line' ? false : true
                        }));

                        chart = new Chart(chartPreview, {
                            type,
                            data: {
                                labels: xLabels,   // ‚úÖ CATEGORY_X ALWAYS HERE
                                datasets
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { position: 'top' }
                                }
                            }
                        });
                    }

                    /* auto re-render */
                    document.querySelectorAll('select, .switch-btn')
                        .forEach(el => el.addEventListener('change', renderChart));

                    renderChart();

                    const switchBtns = document.querySelectorAll('.switch-btn');
                    const chartTypeInput = document.getElementById('chartType');
                    const groupByRow = document.getElementById('groupByRow');
                    const value_y = document.getElementById('value_y');

                    switchBtns.forEach(btn => {
                        btn.addEventListener('click', () => {

                            // switch active button
                            switchBtns.forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');

                            // set hidden input
                            const type = btn.dataset.value;
                            chartTypeInput.value = type;

                            // toggle Group By
                            if (type === 'pie') {
                                groupByRow.style.display = 'none';
                                value_y.style.display = 'none';
                            } else {
                                groupByRow.style.display = 'flex';
                                value_y.style.display = 'flex';
                            }
                        });
                    });
                    
                groupByRow.style.display = 'flex';
                </script>
            <% } %>
            <% if (message1 === 'sort') { %>
                <form action="/sort" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Sort</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%=  filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Sorting Key</div>
                            <div class="conditions">
                                <select name="sortingkey" id="">
                                    <% for (let column of extra_data.data) { %>
                                        <option value="<%=column.name%>_<%=column.type%>"><%= column.name%> ( <%= column.type%> )</option>
                                    <% } %>
                                </select>

                                <select name="sortingorder" id="">
                                    <option value="asc">Ascending</option>
                                    <option value="desc">Descending</option>
                                </select>
                            </div>
                        </div>

                        <div class="popup-field checkboxes-div" style="margin-top: 5px;">
                            <div class="popup-label">Columns</div>
                            <div class="popup-checkboxes">
                                <div>
                                    <input type="checkbox" name="allcolumns" value="*">
                                    <label for="allcolumns" class="popup-label">All Columns</label>
                                </div>

                                <% for (let i = 0; i<extra_data.data.length; i++) { %>
                                    <div>
                                        <input type="checkbox" name="column<%= i+1%>" value="<%= extra_data.data[i].name%>">
                                        <label for="column<%= i+1%>" class="popup-label"><%= extra_data.data[i].name%></label>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Export</div>
                            <div class="popup-checkboxes" style="flex-direction: row; align-items: center;">
                                <div><input type="checkbox" name="export_table" value="true"></div>
                                <label for="export_table" class="popup-label">Export Into Table</label> &nbsp;
                                <label for="tablename" class="popup-label">Table Name &nbsp;</label>
                                <input type="text" name="tablename" class="popup-input">
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Sort</button>
                    </div>
                </form>
            <% } %>
            <% if (message1?.endsWith('split') === true) { %>
                <form action="/split?type=<%=message1%>" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <% if (message1==='verticalsplit'){ %>
                        <div class="popup-header popup-drag-handle">
                            <span> Vertical Split Table</span>
                            <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                        </div>

                        <div class="popup-body">
                            <div class="popup-field">
                                <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                            </div>

                            <div class="popup-field">
                                <div class="popup-label">New Table Name</div>
                                <input type="text" name="new_table_name" class="popup-input" required>
                            </div>

                            <div class="popup-field" style="gap: 10px; margin-top: 5px;">
                                <div class="popup-label">Columns</div>
                                    <div class="popup-checkboxes">
                                            <% for (let i = 0; i<extra_data.data.columns.length; i++) { %>
                                                <div>
                                                    <input type="checkbox" name="column<%= i+1%>" value="<%= extra_data.data.columns[i].name%>" <% if (extra_data.data.columns[i].constraints.includes('primary_key')){ %>disabled<%}%>>
                                                    <label for="column<%= i+1%>" class="popup-label"><%= extra_data.data.columns[i].name%></label>
                                                </div>
                                            <% } %>
                                    </div>
                            </div>
                        </div>
                    <%} else if (message1==='horizontalsplit'){ %>
                        <div class="popup-header popup-drag-handle">
                            <span> Horizontal Split Table</span>
                            <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                        </div>

                        <div class="popup-body">
                            <div class="popup-field">
                                <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                            </div>

                            <div class="popup-field">
                                <div class="popup-label">New Table Name</div>
                                <input type="text" name="new_table_name" class="popup-input" required>
                            </div>

                            <div class="popup-field" style="gap: 10px; margin-top: 5px;">
                                <div class="conditions-div" id="horizontal_split_conditions">
                                    <div class="extra-row" style="margin: 0px;">
                                        <div class="popup-label">Conditions</div>
                                        <button class="extra_button" type="button" onclick="add_condition()">+</button>
                                    </div>
                                    
                                    <div class="conditions" id="horizontal_split_condition1" style="flex-direction: row; gap: 5px;">
                                        <select name="columns1">
                                            <% for (let column of extra_data.data.columns) { %>
                                                <option value="<%= column.name%>"><%= column.name%></option>
                                            <% } %>
                                        </select>

                                        <select class="horizontal_split_operator_select" name="operations1">
                                            <option value="equals">=</option>
                                            <option value="notequals">!=</option>
                                            <option value="lessthan"><</option>
                                            <option value="morethan">></option>
                                            <option value="lessthanequals"><=</option>
                                            <option value="morethanequals">>=</option>
                                            <option value="in">IN</option>
                                        </select>

                                        <input type="text" name="value1" placeholder="Single Value"></input>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <script>
                        let horizontal_split_condition_count = 1;
                        let field_count;
                        function add_condition(){
                            horizontal_split_condition_count += 1;
                            document.querySelector('#horizontal_split_conditions').innerHTML += `
                                <div class="conditions" id="horizontal_split_condition${horizontal_split_condition_count}">
                                    <select name="columns${horizontal_split_condition_count}">
                                    </select>
                                    <select class="horizontal_split_operator_select" name="operations${horizontal_split_condition_count}">
                                        <option value="equals">=</option>
                                        <option value="notequals">!=</option>
                                        <option value="lessthan"><</option>
                                        <option value="morethan">></option>
                                        <option value="lessthanequals"><=</option>
                                        <option value="morethanequals">>=</option>
                                        <option value="in">IN</option>
                                    </select>
                                    <input name="value${horizontal_split_condition_count}" placeholder="Single Value"></input>
                                <div>
                                `;
                            <% for (let column of extra_data.data.columns) { %>
                                    document.querySelector(`#horizontal_split_condition${horizontal_split_condition_count} select`).innerHTML += `
                                        <option value="<%= column.name%>"><%= column.name%></option>
                                    `;
                            <% } %>
                        }

                        document.addEventListener('change', function (e) {
                            if (!e.target.classList.contains('horizontal_split_operator_select')) return;

                            const input = e.target.parentElement.querySelector('input');

                            if (!input) return;

                            if (e.target.value === 'in') {
                                input.placeholder = 'Comma separated values';
                            } else {
                                input.placeholder = 'Single value';
                            }
                        });
                        </script>
                    <%}%>
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Split</button>
                    </div>
                </form>
            <% } %>
            <!-- change join popup to latest -->
            <% if (message1?.endsWith('join') === true) { %>
                <form action="/join?type=<%=message1%>" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span><%=message1 ? message1[0].toUpperCase() + message1.slice(1).replace('join','') : ''%> Join</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>

                        <% if (message1 && (message1 !== 'crossjoin')) { %>
                            <div class="popup-field">
                                <div class="popup-label">Main Key</div>
                                <select name="key1" id="<%=message1 ?? ''%>key1" class="popup-input">
                                    <%for (let table in extra_data.data) { if (table === filename) { for (let column of extra_data.data[table].columns) { %>
                                        <option value="<%=column.name%>"><%= column.name%></option>
                                    <% }}} %>
                                </select>
                            </div>
                        <% } %>

                        <div class="popup-field">
                            <div class="popup-label">Primary Table Columns</div>
                            <div class="popup-checkboxes checkboxes-div" style="margin-top: 5px;">
                                <div>
                                    <input type="checkbox" name="primary_all" value="all">
                                    <label for="primary_all" class="popup-label">All Columns</label>
                                </div>
                                <%for (let table in extra_data.data){ if (table === filename) { for (let i=0; i<extra_data.data[table].columns.length; i++) {%>
                                    <div>
                                        <input type="checkbox" name="primary_<%=i+1%>" value="<%=extra_data.data[table].columns[i].name%>">
                                        <label class="popup-label" for="primary_<%=i+1%>"><%=extra_data.data[table].columns[i].name%></label>
                                    </div>
                                <%}}}%>
                            </div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Joining Table </div>
                            <select name="table2" id="<%=message1 ?? ''%>-table2" class="popup-input">
                                <option value="None">None</option>
                                <%for (let file_name in extra_data.data){ if (file_name.endsWith('.txt.json')) {%>
                                    <option value="<%= file_name%>"><%= file_name%></option>
                                <% }} %>
                            </select>    
                        </div>

                        <% if ( message1 && (message1 !== 'crossjoin' )) { %>
                            <div class="popup-field">
                                <div class="popup-label">Joining Key</div>
                                <select name="key2" id="<%=message1 ?? ''%>-key2" class="popup-input"><option value="None">None</option></select>
                            </div>
                        <% } %>

                        <div class="popup-field checkboxes-div" style="margin-top: 5px;">
                            <div class="popup-label">Secondary Table Columns</div>
                            <div id="<%=message1 ?? ''%>_columnlist" class="popup-checkboxes"></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Export</div>
                            <div class="popup-checkboxes" style="flex-direction: row; align-items: center;">
                                <div><input type="checkbox" name="export_table" value="true"></div>
                                <label for="export_table" class="popup-label">Export Into Table</label> &nbsp;
                                <label for="tablename" class="popup-label">Table Name &nbsp;</label>
                                <input type="text" name="tablename" class="popup-input">
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Join</button>
                    </div>
                </form>
                <script>
                    const join_tableData = <%- JSON.stringify(extra_data.data)%>;
                    const join_name = "<%=message1%>";

                    const _tableSelect = document.getElementById(`${join_name}-table2`);
                    let _keySelect;
                    if ("<%=message1%>" !== 'crossjoin'){
                        _keySelect = document.getElementById(`${join_name}-key2`);
                        _tableSelect.addEventListener('change', () => {
                            const selectedTable = _tableSelect.value;
                            _keySelect.innerHTML = '';

                            join_tableData[selectedTable].columns.forEach(col => {
                                const option = document.createElement('option');
                                option.value = col.name;
                                option.textContent = col.name;
                                _keySelect.appendChild(option);
                            });

                            document.querySelector(`#${join_name}_columnlist`).innerHTML=`
                                <div>
                                    <input type="checkbox" name="secondary_all" value="all">
                                    <label for="all" class="popup-label">All Columns</label>
                                </div>
                            `;
                            
                            let _secondary_count=1;
                            for (let column of join_tableData[selectedTable].columns){
                                document.querySelector(`#${join_name}_columnlist`).innerHTML+=`
                                <div>
                                    <input type="checkbox" name="secondary_${_secondary_count}" value="${column.name}">
                                    <label class="popup-label" for="secondary${_secondary_count++}">${column.name}</label>
                                </div>
                            `;
                            }
                        });
                    }
                    else if ("<%= message1%>" === 'crossjoin'){
                        _tableSelect.addEventListener('change', () => {
                            const selectedTable = _tableSelect.value;

                            document.querySelector(`#${join_name}_columnlist`).innerHTML=`
                                <div>
                                    <input type="checkbox" name="secondary_all" value="all">
                                    <label for="all" class="popup-label">All Columns</label>
                                </div>
                            `;
                            
                            let _secondary_count=1;
                            for (let column of join_tableData[selectedTable].columns){
                                document.querySelector(`#${join_name}_columnlist`).innerHTML+=`
                                <div>
                                    <input type="checkbox" name="secondary_${_secondary_count}" value="${column.name}">
                                    <label class="popup-label" for="secondary${_secondary_count++}">${column.name}</label>
                                </div>
                            `;
                            }
                        });
                    }
                    
                    _tableSelect.addEventListener('change', () => {
                        const selectedTable = _tableSelect.value;
                        _keySelect.innerHTML = '';

                        join_tableData[selectedTable].columns.forEach(col => {
                            const option = document.createElement('option');
                            option.value = col.name;
                            option.textContent = col.name;
                            _keySelect.appendChild(option);
                        });

                        document.querySelector(`#${join_name}_columnlist`).innerHTML=`
                            <div>
                                <input type="checkbox" name="secondary_all" value="all">
                                <label for="all" class="popup-label">All Columns</label>
                            </div>
                        `;
                        
                        let _secondary_count=1;
                        for (let column of join_tableData[selectedTable].columns){
                            document.querySelector(`#${join_name}_columnlist`).innerHTML+=`
                            <div>
                                <input type="checkbox" name="secondary_${_secondary_count}" value="${column.name}">
                                <label class="popup-label" for="secondary${_secondary_count++}">${column.name}</label>
                            </div>
                        `;
                        }
                    });

                </script>
            <% } %>
            
            <% if (message1 === 'deletekeyvalue') { %>
                
                <form action="/deletekeyvalue" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Delete Key-Value</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Predefined Options</div>
                            <select name="predefinedoptions" class="popup-input">
                                <option value="none">None</option>
                                <option value="allkeys">All Keys</option>
                                <option value="first10">First 10</option>
                                <option value="last10">Last 10</option>
                            </select>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Custom Options</div>

                            <div id="delselects">
                                <select name="select1" id="delselect">
                                    <option value="none">None</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Delete</button>
                    </div>
                </form>
                <script>
                    const deldata = <%- JSON.stringify(extra_data.data)%>;
                    let del_selects_count = 1;

                    let delrootSelect = document.querySelector('#delselects select');
                    delfillOptions(delrootSelect, deldata);

                    // function to add options
                    function delfillOptions(select, obj) {
                        for (let key in obj) {
                            let option = document.createElement("option");
                            option.value = key;
                            option.textContent = key;
                            select.appendChild(option);
                        }
                    }

                    // listen for changes on both selects and inputs
                    document.querySelector('#delselects').addEventListener('change', function(e) {
                        // Handle both SELECT and INPUT changes
                        if (e.target.tagName !== "SELECT" && e.target.tagName !== "INPUT") return;

                        // Remove all elements after the changed element
                        let nextElement = e.target.nextElementSibling;
                        while (nextElement) {
                            let toRemove = nextElement;
                            nextElement = nextElement.nextElementSibling;
                            toRemove.remove();
                        }

                        let parentValue = delgetValueFromPath();

                        if (Array.isArray(parentValue)) {
                            del_selects_count++;
                            let input = document.createElement("input");
                            input.type = "number";
                            input.name = `index${del_selects_count}`;
                            input.placeholder = "Index";
                            input.min = -1;
                            input.max = parentValue.length - 1;
                            e.target.insertAdjacentElement("afterend", input);
                        } 
                        else if (typeof parentValue === "object" && parentValue !== null) {
                            del_selects_count++;
                            let newSelect = document.createElement("select");
                            newSelect.name = `select${del_selects_count}`;

                            // None option
                            let none = document.createElement("option");
                            none.value = 'none';
                            none.textContent = "None";
                            newSelect.appendChild(none);

                            // All option
                            let all = document.createElement("option");
                            all.value = 'all';
                            all.textContent = "All";
                            newSelect.appendChild(all);

                            delfillOptions(newSelect, parentValue);
                            e.target.insertAdjacentElement("afterend", newSelect);
                        } 
                    });

                    // helper ‚Üí walk down based on selected values (both selects and inputs)
                    function delgetValueFromPath() {
                        let container = document.querySelector('#delselects');
                        let elements = container.querySelectorAll('select, input[type="number"]');
                        let val = deldata;
                        
                        elements.forEach(elem => {
                            if (elem.tagName === 'SELECT' && elem.value && elem.value !== 'none') {
                                val = val[elem.value];
                            } else if (elem.tagName === 'INPUT' && elem.value !== '') {
                                val = val[parseInt(elem.value)];
                            }
                        });
                        
                        return val;
                    }
                </script>
              
            <% } %>
            <% if (message1 === 'deleterow'){ %>
                <form action="/deleterow" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Delete Row</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Predefined Options</div>
                            <select name="predefinedoptions" class="popup-input">
                                <option value="none">None</option>
                                <option value="allrows">All Rows</option>
                                <option value="first100">First 100</option>
                                <option value="last100">Last 100</option>
                            </select>
                        </div>

                        <div class="popup-field" style="gap: 12px">
                            <div class="popup-label">Custom Options</div>
                            <div class="popup-middle-options"  style="display: flex; gap: 100px;">
                                <div class="checkboxes-div" style="margin-top: 5px;">
                                    <div class="popup-label">Columns</div>

                                    <div class="popup-checkboxes">
                                        <div>
                                            <input type="checkbox" name="allcolumns" value="*">
                                            <label for="allcolumns" class="popup-label">All Columns</label>
                                        </div>

                                        <% for (let i = 0; i<extra_data.columns.length; i++) { %>
                                            <div>
                                                <input type="checkbox" name="column<%= i+1%>" value="<%= extra_data.columns[i].name%>">
                                                <label for="column<%= i+1%>" class="popup-label"><%= extra_data.columns[i].name%></label>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="conditions-div" id="select_delete_conditions">
                                    <div class="extra-row" style="margin: 0px;">
                                        <div class="popup-label">Conditions</div>
                                        <button class="extra_button" type="button" onclick="add_delete_condition()">+</button>
                                    </div>
                                    
                                    <div class="conditions" id="deletecondition1" style="flex-direction: row; gap: 5px;">
                                        <select name="columns1">
                                            <% for (let column of extra_data.columns) { %>
                                                <option value="<%= column.name%>"><%= column.name%></option>
                                            <% } %>
                                        </select>

                                        <select name="operations1" class="delete-conditions-select">
                                            <option value="equals">=</option>
                                            <option value="notequals">!=</option>
                                            <option value="lessthan"><</option>
                                            <option value="morethan">></option>
                                            <option value="lessthanequals"><=</option>
                                            <option value="morethanequals">>=</option>
                                            <option value="in">IN</option>
                                        </select>

                                        <input name="value1" placeholder="Single value"></input>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Delete</button>
                    </div>
                </form>
                <script>
                    let delete_condition_count = 1;

                    function add_delete_condition(){
                        delete_condition_count += 1;
                        document.querySelector('#select_delete_conditions').innerHTML += `
                            <div class="conditions" id="deletecondition${delete_condition_count}"">
                                <select name="columns${delete_condition_count}">
                                </select>
                                <select name="operations${delete_condition_count}" class="delete-conditions-select">
                                    <option value="equals">=</option>
                                    <option value="notequals">!=</option>
                                    <option value="lessthan"><</option>
                                    <option value="morethan">></option>
                                    <option value="lessthanequals"><=</option>
                                    <option value="morethanequals">>=</option>
                                    <option value="in">IN</option>
                                </select>
                                <input name="value${delete_condition_count}" placeholder="Single value"></input>
                            <div>
                            `;
                        <% for (let column of extra_data.columns) { %>
                                document.querySelector(`#deletecondition${delete_condition_count} select`).innerHTML += `
                                    <option value="<%= column.name%>"><%= column.name%></option>
                                `;
                        <% } %>
                    }

                    document.addEventListener('change', function (e) {
                            if (!e.target.classList.contains('delete-conditions-select')) return;

                            const input = e.target.parentElement.querySelector('input');

                            if (!input) return;

                            if (e.target.value === 'in') {
                                input.placeholder = 'Comma separated values';
                            } else {
                                input.placeholder = 'Single value';
                            }
                        });
                </script>
            <% } %>
            <% if (message1 === 'updatekeyvalue') { %>
                <form action="/updatekeyvalue" class="popup-card" method="POST" onsubmit="return prepareUpdateForm(event)">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">
                    <input type="hidden" name="username" value="<%= username%>">
                    <input type="hidden" name="password" value="<%= password%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Update Key-Value</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Select Key Path</div>
                            <div id="update-keys">
                                <select name="updateselect1" data-index="0">
                                    <option value="">None</option>
                                </select>
                            </div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">New Value</div>
                            <input type="text" name="update_value" class="popup-input" placeholder="Enter new value" required>
                        </div>
                        
                        <!-- Hidden input to store the final selected_keys array -->
                        <input type="hidden" name="selected_keys" id="update_selected_keys_input">
                    </div>

                    <div class="popup-footer">
                        <button type="submit" class="popup-primary-btn">Update</button>
                    </div>
                </form>
                <script>
                    const update_data = <%- JSON.stringify(extra_data.data)%>;
                    let updates_count = 1;

                    let rootUpdate = document.querySelector('#update-keys select');
                    fillOptions(rootUpdate, update_data);

                    // function to add options
                    function fillOptions(select, obj) {
                        for (let key in obj) {
                            let option = document.createElement("option");
                            option.value = key;
                            option.textContent = key;
                            select.appendChild(option);
                        }
                    }

                    // listen for changes on both selects and inputs
                    document.querySelector('#update-keys').addEventListener('change', function(e) {
                        // Handle both SELECT and INPUT changes
                        if (e.target.tagName !== "SELECT" && e.target.tagName !== "INPUT") return;

                        // Remove all elements after the changed element
                        let nextElement = e.target.nextElementSibling;
                        while (nextElement) {
                            let toRemove = nextElement;
                            nextElement = nextElement.nextElementSibling;
                            toRemove.remove();
                        }

                        let parentValue = getValueFromPath();

                        if (Array.isArray(parentValue)) {
                            updates_count++;
                            let input = document.createElement("input");
                            input.type = "number";
                            input.name = `updateindex${updates_count}`;
                            input.placeholder = "Index";
                            input.min = -1;
                            input.max = parentValue.length - 1;
                            input.setAttribute('data-index', updates_count);
                            e.target.insertAdjacentElement("afterend", input);
                        } 
                        else if (typeof parentValue === "object" && parentValue !== null) {
                            updates_count++;
                            let newSelect = document.createElement("select");
                            newSelect.name = `updateselect${updates_count}`;
                            newSelect.setAttribute('data-index', updates_count);

                            // None option
                            let none = document.createElement("option");
                            none.value = '';
                            none.textContent = "None";
                            newSelect.appendChild(none);

                            // All option
                            let all = document.createElement("option");
                            all.value = 'all';
                            all.textContent = "All";
                            newSelect.appendChild(all);

                            fillOptions(newSelect, parentValue);
                            e.target.insertAdjacentElement("afterend", newSelect);
                        } 
                    });

                    // helper ‚Üí walk down based on selected values (both selects and inputs)
                    function getValueFromPath() {
                        let container = document.querySelector('#update-keys');
                        let elements = container.querySelectorAll('select, input[type="number"]');
                        let val = update_data;
                        
                        elements.forEach(elem => {
                            if (elem.tagName === 'SELECT' && elem.value && elem.value !== '') {
                                val = val[elem.value];
                            } else if (elem.tagName === 'INPUT' && elem.value !== '') {
                                val = val[parseInt(elem.value)];
                            }
                        });
                        
                        return val;
                    }

                    // Prepare form before submission
                    function prepareUpdateForm(event) {
                        // Build selected_keys array from custom options
                        let container = document.querySelector('#update-keys');
                        let elements = container.querySelectorAll('select, input[type="number"]');
                        let selected_keys = [];
                        
                        elements.forEach(elem => {
                            if (elem.tagName === 'SELECT') {
                                if (elem.value && elem.value !== '') {
                                    selected_keys.push(elem.value);
                                }
                            } else if (elem.tagName === 'INPUT') {
                                if (elem.value !== '') {
                                    selected_keys.push(parseInt(elem.value));
                                }
                            }
                        });

                        // If no keys selected, show error
                        if (selected_keys.length === 0) {
                            alert('Please select at least one key to update');
                            event.preventDefault();
                            return false;
                        }

                        // Set the hidden input value as JSON string
                        document.getElementById('update_selected_keys_input').value = JSON.stringify(selected_keys);
                        
                        return true;
                    }
                </script>
            
                <% } %>
            <% if (message1 === 'updaterow') { %>
                <form action="/updaterow" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Update Row</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%=  filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="extra-row" style="margin: 0px;">
                                <div class="popup-label">Update Column(s)</div>
                                <button class="extra_button" type="button" onclick="add_update_column()">+</button>
                            </div>

                            <div id="row-update-selects">
                                <div class="conditions">
                                    <select name="column1" id="">
                                        <% for (let column of extra_data.data) { if (column.type !== 'derivative'){%>
                                            <option value="<%=column.name%>_<%=column.type%>"><%= column.name%> ( <%= column.type%> )</option>
                                        <% }} %>
                                    </select>
                                    <input type="text" name="value1">
                                </div>
                            </div>
                        </div>

                        <div class="popup-field">
                            <div class="extra-row" style="margin: 0px;">
                                <div class="popup-label">Update Condition(s)</div>
                                <button class="extra_button" type="button" onclick="add_update_condition()">+</button>
                            </div>

                            <div class="popup-middle-options conditions-div" id="row-update-conditions">
                                <div class="select_condition conditions"  style="flex-direction: row; gap: 5px;">
                                    <select name="conditioncolumn1">
                                        <% for (let column of extra_data.data) { %>
                                            <option value="<%= column.name%>"><%= column.name%></option>
                                        <% } %>
                                    </select>

                                    <select name="conditionoperation1" class="update-conditions-select">
                                        <option value="equals">=</option>
                                        <option value="notequals">!=</option>
                                        <option value="lessthan"><</option>
                                        <option value="morethan">></option>
                                        <option value="lessthanequals"><=</option>
                                        <option value="morethanequals">>=</option>
                                        <option value="in">IN</option>
                                    </select>

                                    <input name="conditionvalue1" placeholder="Single value"></input>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Update</button>
                    </div>
                </form>
                <script>
                    let update_conditions = 1;
                    let update_selects = 1;
                    const rowupdate_data = <%- JSON.stringify(extra_data.data)%>;

                    function add_update_condition(){
                        update_conditions++;
                        let add_html = `<div class="select_condition conditions"> <select name="conditioncolumn${update_conditions}"> `;
                        for (let column of rowupdate_data) add_html += `<option value="${column.name}">${column.name}</option>`;
                        add_html += `
                        </select>
                        <select name="conditionoperation${update_conditions}" class="update-conditions-select">
                            <option value="equals">=</option>
                            <option value="notequals">!=</option>
                            <option value="lessthan"><</option>
                            <option value="morethan">></option>
                            <option value="lessthanequals"><=</option>
                            <option value="morethanequals">>=</option>
                            <option value="in">IN</option>
                        </select>
                        <input name="conditionvalue${update_conditions}"></input>
                        </div>
                        `;
                        document.querySelector('#row-update-conditions').innerHTML += add_html;
                    }
                    function add_update_column(){
                        update_selects++;
                        let add_html = `<div class="conditions"><select name="column${update_selects}">`;
                        for (let column of rowupdate_data) add_html += `<option value="${column.name}_${column.type}">${column.name} ( ${column.type} )</option>`;
                        add_html += `</select> <input type="text" name="value${update_selects}"></div>`;
                        document.querySelector('#row-update-selects').innerHTML += add_html;
                    }
                    document.addEventListener('change', function (e) {
                            if (!e.target.classList.contains('update-conditions-select')) return;

                            const input = e.target.parentElement.querySelector('input');

                            if (!input) return;

                            if (e.target.value === 'in') {
                                input.placeholder = 'Comma separated values';
                            } else {
                                input.placeholder = 'Single value';
                            }
                        });
                </script>
            <% } %>

            <% if (message1 === 'selectkeyvalue') { %>
                <form action="/selectkeyvalue" class="popup-card" method="POST">
                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Select Key</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">
                        <div class="popup-field">
                            <div class="filename-header">Filename: <%= filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Predefined Options</div>
                            <select name="predefinedoptions" class="popup-input">
                                <option value="none">None</option>
                                <option value="allkeys">All Keys</option>
                                <option value="first10">First 10</option>
                                <option value="last10">Last 10</option>
                            </select>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Custom Options</div>

                            <div id="selects">
                                <select name="select1" id="select">
                                    <option value="none">None</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Retrieve</button>
                    </div>

                </form>
                <script>
                    const data = <%- JSON.stringify(extra_data.data)%>;
                    let selects_count = 1;
                    let inputs_count = 0;

                    let rootSelect = document.querySelector('#selects select');
                    fillOptions(rootSelect, data);

                    // function to add options
                    function fillOptions(select, obj) {
                        for (let key in obj) {
                            let option = document.createElement("option");
                            option.value = key;
                            option.textContent = key;
                            select.appendChild(option);
                        }
                    }

                    // function to handle navigation after selecting a value
                    function handleNavigation(element, parentValue) {
                        // Remove all siblings after this element
                        let nextSibling = element.nextElementSibling;
                        while (nextSibling) {
                            let toRemove = nextSibling;
                            nextSibling = nextSibling.nextElementSibling;
                            toRemove.remove();
                        }

                        if (Array.isArray(parentValue)) {
                            inputs_count++;
                            let input = document.createElement("input");
                            input.type = "number";
                            input.name = `index${inputs_count}`;
                            input.className = "array-index-input";
                            input.min = -1;
                            input.max = parentValue.length - 1;
                            // input.placeholder = `0-${parentValue.length - 1}`;
                            input.placeholder = "Index";
                            element.insertAdjacentElement("afterend", input);
                        } 
                        else if (typeof parentValue === "object" && parentValue !== null) {
                            selects_count++;
                            let newSelect = document.createElement("select");
                            newSelect.name = `select${selects_count}`;

                            // none option
                            let none = document.createElement("option");
                            none.value = 'none';
                            none.textContent = "None";
                            newSelect.appendChild(none);

                            // all option
                            let all = document.createElement("option");
                            all.value = 'all';
                            all.textContent = "All";
                            newSelect.appendChild(all);

                            fillOptions(newSelect, parentValue);
                            element.insertAdjacentElement("afterend", newSelect);
                        }
                    }

                    // listen for changes on both selects AND inputs
                    document.querySelector('#selects').addEventListener('change', function(e) {
                        if (e.target.tagName === "SELECT") {
                            if (e.target.value === 'none') {
                                // Remove all siblings after this select
                                let nextSibling = e.target.nextElementSibling;
                                while (nextSibling) {
                                    let toRemove = nextSibling;
                                    nextSibling = nextSibling.nextElementSibling;
                                    toRemove.remove();
                                }
                                return;
                            }

                            let parentValue = getValueFromPath(e.target);
                            handleNavigation(e.target, parentValue);
                        }
                    });

                    // listen for input changes (array indices)
                    document.querySelector('#selects').addEventListener('input', function(e) {
                        if (e.target.tagName === "INPUT" && e.target.type === "number") {
                            let value = Number(e.target.value);
                            
                            if (Number.isNaN(value)) return;

                            let parentValue = getValueFromPath(e.target);
                            
                            // Only proceed if the value is valid
                            if (parentValue !== undefined) {
                                handleNavigation(e.target, parentValue);
                            }
                        }
                    });

                    // helper ‚Üí walk down based on selected values up to the given element
                    function getValueFromPath(upToElement) {
                        let elements = document.querySelectorAll('#selects select, #selects input');
                        let val = data;
                        
                        for (let elem of elements) {
                            if (elem.tagName === "SELECT") {
                                if (elem.value && elem.value !== 'none') {
                                    val = val[elem.value];
                                }
                            } else if (elem.tagName === "INPUT") {
                                let idx = Number(elem.value);
                                if (!Number.isNaN(idx) && Array.isArray(val)) {
                                    val = val[idx];
                                }
                            }
                            
                            // Stop at the element that triggered the change
                            if (elem === upToElement) break;
                        }
                        
                        return val;
                    }
                </script>
            <% } %>

            <% if (message1 === 'selectrow') { %>

                <form action="/selectrow" class="popup-card" method="POST">

                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Select Row</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">

                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field">
                            <div class="popup-label">Predefined Options</div>
                            <select name="predefinedoptions" class="popup-input">
                                <option value="none">None</option>
                                <option value="allrows">All Rows</option>
                                <option value="first100">First 100</option>
                                <option value="last100">Last 100</option>
                            </select>
                        </div>

                        <div class="popup-field" style="gap: 12px;">
                            <div class="popup-label">Custom Options</div>
                            <div style="display: flex; gap: 100px;">
                                <div class="checkboxes-div" style="margin-top: 5px;">
                                    <div class="popup-label">Columns</div>

                                    <div class="popup-checkboxes">
                                        <div>
                                            <input type="checkbox" name="allcolumns" value="*">
                                            <label for="allcolumns" class="popup-label">All Columns</label>
                                        </div>

                                        <% for (let i = 0; i<extra_data.columns.length; i++) { %>
                                            <div>
                                                <input type="checkbox" name="column<%= i+1%>" value="<%= extra_data.columns[i].name%>">
                                                <label for="column<%= i+1%>" class="popup-label"><%= extra_data.columns[i].name%></label>
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="conditions-div" id="select_conditions">
                                    <div class="extra-row" style="margin: 0px;">
                                        <div class="popup-label">Conditions</div>
                                        <button class="extra_button" type="button" onclick="add_condition()">+</button>
                                    </div>
                                    
                                    <div class="conditions" id="condition1" style="flex-direction: row; gap: 5px;">
                                        <select name="columns1">
                                            <% for (let column of extra_data.columns) { %>
                                                <option value="<%= column.name%>"><%= column.name%></option>
                                            <% } %>
                                        </select>

                                        <select name="operations1" class="select-conditions-select">
                                            <option value="equals">=</option>
                                            <option value="notequals">!=</option>
                                            <option value="lessthan"><</option>
                                            <option value="morethan">></option>
                                            <option value="lessthanequals"><=</option>
                                            <option value="morethanequals">>=</option>
                                            <option value="in">IN</option>
                                        </select>

                                        <input type="text" name="value1" placeholder="Single value"></input>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Retrieve</button>
                    </div>

                </form>
                <script>
                    let table_condition_count = 1;
                    function add_condition(){
                        table_condition_count += 1;
                        document.querySelector('#select_conditions').innerHTML += `
                            <div class="conditions" id="condition${table_condition_count}"">
                                <select name="columns${table_condition_count}">
                                </select>
                                <select name="operations${table_condition_count}" class="select-conditions-select">
                                    <option value="equals">=</option>
                                    <option value="notequals">!=</option>
                                    <option value="lessthan"><</option>
                                    <option value="morethan">></option>
                                    <option value="lessthanequals"><=</option>
                                    <option value="morethanequals">>=</option>
                                    <option value="in">IN</option>
                                </select>
                                <input name="value${table_condition_count}" placeholder="Single value"></input>
                            <div>
                            `;
                        <% for (let column of extra_data.columns) { %>
                                document.querySelector(`#condition${table_condition_count} select`).innerHTML += `
                                    <option value="<%= column.name%>"><%= column.name%></option>
                                `;
                        <% } %>
                    }

                    document.addEventListener('change', function (e) {
                            if (!e.target.classList.contains('select-conditions-select')) return;

                            const input = e.target.parentElement.querySelector('input');

                            if (!input) return;

                            if (e.target.value === 'in') {
                                input.placeholder = 'Comma separated values';
                            } else {
                                input.placeholder = 'Single value';
                            }
                        });
                </script>
            <% } %>
            
            <% if (message1 === 'insertkeyvalue') { %>

                <form action="/insertkeyvalue" class="popup-card" method="POST">

                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                    <div class="popup-header popup-drag-handle">
                        <span>Insert Key-Value</span>
                        <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                    </div>

                    <div class="popup-body">

                        <div class="popup-field">
                            <div class="filename-header">Filename:  <%= filename.split('.')[0]%></div>
                        </div>

                        <div class="popup-field" style="flex-direction: row; gap: 100px;">
                            
                                <div class="extra-row">
                                    Add Key-Value Pair(s)
                                &nbsp;
                                <button type="button" onclick="add_keyvalue_row()">+</button>
                                </div>

                                <div class="extra-row">
                                    Select Clash Behaviour &nbsp;
                                    <select name="clashbehaviour" class="popup-input">
                                        <option value="replace">Replace</option>
                                        <option value="append">Append</option>
                                        <option value="merge">Merge</option>
                                        <option value="ignore">Ignore</option>
                                    </select>
                                </div>
                            
                        </div>

                        <div class="popup-field">
                            <div id="key-values" style="display: flex;
                            gap: 3px;">

                                <div class="column-header">
                                    <div class="column-header-field">Key</div>
                                    <div class="column-header-field">Value</div>
                                </div>

                                <div class="row">
                                    <input type="text" name="key_1">
                                    <!-- <input type="text" name="datatype_1"> -->
                                    <input type="text" name="value_1"></input>
                                </div>

                            </div>
                        </div>

                    </div>

                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Create</button>
                    </div>

                </form>
                <script>
                    let keyvalue_row_count = 1;
    
                    function add_keyvalue_row(){
                        keyvalue_row_count += 1;

                        document.querySelector('#key-values').innerHTML += `
                            <div class="row" ">
                                <input type="text" name="key_${keyvalue_row_count}"> 
                                <input type="text" name="value_${keyvalue_row_count}"></input>
                            </div>
                        `; 
                    }
                </script>
            <% } %>

            <% if ( message1 === 'insertrow' ) { %>

                <form action="/insertrow" class="popup-card" method="POST">

                    <input type="hidden" name="filename" value="<%= filename%>">
                    <input type="hidden" name="databasename" value="<%= databasename%>">

                <div class="popup-header popup-drag-handle">
                    <span>Insert Row</span>
                    <button type="button" name="cancel" class="popup-close" onclick="cancel_popup()">X</button>
                </div>

                <div class="popup-body">
                    <div class="popup-field">
                        <div class="filename-header">Filename:  <%= extra_data.filename.split('.')[0]%></div>
                    </div>

                    <div class="popup-field">

                        <div class="extra-row">
                            Add Row(s)
                            &nbsp;
                            <button type="button" onclick="add_row()">+</button>
                        </div>

                        <div style="display: flex; gap: 3px;">
                            <div class="column-header">
                                <% for (let column of extra_data.columns) { %>
                                    <div class="column-header-field">
                                        <%= column.name%> ( <%= column.type%> )
                                    </div>
                                <% } %>
                            </div>
                            

                            <div id="rows">
                                <!-- row 1 -->
                                <div class="row">
                                    <% for (let column of extra_data.columns) { %>
                                        <input type="text" name="row_1_col_<%= column.name%>" <%= column.type === 'derivative' ? 'disabled' : '' %>>
                                    <% } %>
                                </div>

                            </div>
                        </div>
                        
                    </div>
                </div>                

                <div class="popup-footer">
                    <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Create</button>
                </div>

                </form>
                <script>
                    let row_count = 1;
    
                    function add_row(){
                        row_count += 1;
                        let rowHTML = ``;
                        
                        rowHTML += '<div class="row"">';
                        <% for (let column of extra_data.columns) { %>
                            rowHTML += `
                                <input type="text" name="row_${row_count}_col_<%= column.name%>"<%= column.type === 'derivative' ? 'disabled' : '' %>>  
                            `;
                        <% } %>
                        rowHTML += '</div>';

                        document.querySelector('#rows').innerHTML += rowHTML;
                        
                    }
                </script>
            <% } %>
            
            <% if (message1 === 'insertdatabase') { %> 
                <form action="/insertdatabase" method="POST" class="popup-card">

                    <!-- HEADER -->
                    <div class="popup-header popup-drag-handle">
                        <span>Insert Database</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <!-- BODY -->
                    <div class="popup-body">
                        <div class="popup-field">
                            <label class="popup-label">Database name</label>
                            <input type="text" name="databasename" class="popup-input">
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Create</button>
                    </div>

                </form>
            <% } %>

            <% if (message1 === 'deletedatabase') { %> 
                <form action="/deletedatabase" method="POST" class="popup-card">

                    <!-- HEADER -->
                    <div class="popup-header popup-drag-handle">
                        <span>Delete Database</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <!-- BODY -->
                    <div class="popup-body">
                        <div class="popup-field">
                            <label class="popup-label">Select Database</label>
                            <select name="database" id="" class="popup-input">
                                <% for (let database of databases) { %>
                                    <option value="<%= database.database_name %>">
                                        <%= database.database_name %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Delete</button>
                    </div>

                </form>
            <% } %>

            <% if (message1 === 'renamedatabase') { %> 
                <form action="/renamedatabase" method="POST" class="popup-card">

                    <!-- HEADER -->
                    <div class="popup-header popup-drag-handle">
                        <span>Rename Database</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <!-- BODY -->
                    <div class="popup-body">
                        <div class="popup-field">
                            <label class="popup-label">Select Database</label>
                            <select name="database" id="" class="popup-input">
                                <% for (let database of databases) { %>
                                    <option value="<%= database.database_name %>">
                                        <%= database.database_name %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="popup-field">
                            <label class="popup-label">Database New Name</label>
                            <input type="text" name="databasename" class="popup-input">
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Rename</button>
                    </div>

                </form>
            <% } %>

            <% if (message1 === 'deletefile') { %> 
                <form action="/deletefile" method="POST" class="popup-card">

                    <!-- HEADER -->
                    <div class="popup-header popup-drag-handle">
                        <span>Delete File</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <!-- BODY -->
                    <div class="popup-body">
                        <div class="popup-field">
                            <label class="popup-label">Select Database</label>
                            <select name="database" id="delete-file-database-select" class="popup-input">
                                <% for (let database of databases) { %>
                                    <option value="<%= database.database_name %>">
                                        <%= database.database_name %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="popup-field">
                            <label class="popup-label">Select File</label>
                            <select name="file" id="delete-file-select" class="popup-input">
                                <%for (let file of databases[0].database_files){ %>
                                    <option value="<%= file%>"><%= file%></option>
                                <%}%>
                            </select>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Delete</button>
                    </div>

                </form>
                <script>
                    let delete_databases = <%- JSON.stringify(databases)%>;
                    document.getElementById('delete-file-database-select').addEventListener('change', (e)=>{
                        const select = document.querySelector('#delete-file-select');
                        let files;
                        for (let i=0; i<delete_databases.length; i++){
                            if (delete_databases[i].database_name === e.target.value){
                                files = delete_databases[i].database_files;
                                break;
                            }
                        }
                        
                        let delete_file_select_innerText;
                        for (let file of files){
                            delete_file_select_innerText+=`
                                <option value="${file}">${file}</option>
                            `;
                        }
                        select.innerHTML = delete_file_select_innerText;
                    });
                </script>
            <% } %>

            <% if (message1 === 'renamefile') { %> 
                <form action="/renamefile" method="POST" class="popup-card">

                    <!-- HEADER -->
                    <div class="popup-header popup-drag-handle">
                        <span>Rename File</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <!-- BODY -->
                    <div class="popup-body">
                        <div class="popup-field">
                            <label class="popup-label">Select Database</label>
                            <select name="database" id="rename-file-database-select" class="popup-input">
                                <% for (let database of databases) { %>
                                    <option value="<%= database.database_name %>">
                                        <%= database.database_name %>
                                    </option>
                                <% } %>
                            </select>
                        </div>
                        <div class="popup-field">
                            <label class="popup-label">Select File</label>
                            <select name="file" id="rename-file-select" class="popup-input">
                                <%for (let file of databases[0].database_files){ %>
                                    <option value="<%= file%>"><%= file%></option>
                                <%}%>
                            </select>
                        </div>
                        <div class="popup-field">
                            <label for="" class="popup-label">File New Name</label>
                            <input type="text" name="name" class="popup-input">
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Rename</button>
                    </div>

                </form>
                <script>
                    let rename_databases = <%- JSON.stringify(databases)%>;
                    document.getElementById('rename-file-database-select').addEventListener('change', (e)=>{
                        const select = document.querySelector('#rename-file-select');
                        let files;
                        for (let i=0; i<rename_databases.length; i++){
                            if (rename_databases[i].database_name === e.target.value){
                                files = rename_databases[i].database_files;
                                break;
                            }
                        }
                        
                        let rename_file_select_innerText;
                        for (let file of files){
                            rename_file_select_innerText+=`
                                <option value="${file}">${file}</option>
                            `;
                        }
                        select.innerHTML = rename_file_select_innerText;
                    });
                </script>
            <% } %>

            <% if (message1 === 'insertfile') { %>

                <form action="/insertfile" class="popup-card" method="POST">

                    <div class="popup-header popup-drag-handle">
                        <span>Insert File</span>
                        <button type="button" class="popup-close" onclick="cancel_popup()">‚úï</button>
                    </div>

                    <div class="popup-body">

                        <!-- File name -->
                        <div class="popup-field">
                            <label class="popup-label">File name</label>
                            <input type="text" name="filename" class="popup-input">
                        </div>

                        <!-- Select database -->
                        <div class="popup-field">
                            <label class="popup-label">Select database</label>
                            <select name="databaseselect" id="databaseselect" class="popup-input">
                                <% for (let database of databases) { %>
                                    <option value="<%= database.database_name %>">
                                        <%= database.database_name %>
                                    </option>
                                <% } %>
                            </select>
                        </div>

                        <!-- File type -->
                        <div class="popup-field">
                            <label class="popup-label">File type</label>
                            <select name="filetypeselect" id="filetypeselect" class="popup-input">
                                <option value="">None</option>
                                <option value="table">Table</option>
                                <option value="json">Object</option>
                            </select>
                        </div>

                        <!-- Dynamic section (Table builder / JSON info) -->
                        <div class="popup-field" id="file-builder" style="display:none;">
                            <div class="popup-label" id="fileheader"></div>
                            <div id="filecontents"></div>
                        </div>

                    </div>
                    <div class="popup-footer">
                        <button type="submit" onclick="cancel_popup()" class="popup-primary-btn">Create</button>
                    </div>                             
                </form>
                <script>
                    function add_column(){
                        column_count +=1;
                        document.querySelector('#filecontents-table').innerHTML +=`
                        <tr>
                                <td><input type="text" name="columnname${column_count}"></td>
                                <td>
                                    <select name="columntype${column_count}" class="column-type">
                                        <option value="int">Int</option>
                                        <option value="float">Float</option>
                                        <option value="string">String</option>    
                                        <option value="derivative">Derivative</option> 
                                    </select>

                                    <input
                                        type="text"
                                        name="derivativeinfo"
                                        class="derivative-input"
                                        placeholder="Formula / logic"
                                        style="display:none; margin-top:4px;"
                                    >
                                </td>
                                <td class="constraints">
                                    <input type="checkbox" name="notnull${column_count}">&nbsp;
                                    <label for="notnull${column_count}">Not Null</label>&nbsp;

                                    <input type="checkbox" name="primarykey${column_count}">&nbsp;
                                    <label for="primarykey${column_count}">Primary Key</label>&nbsp;

                                    <input type="checkbox" name="unique${column_count}">&nbsp;
                                    <label for="unique${column_count}">Unique</label>&nbsp;

                                    <input type="checkbox" name="serial${column_count}">&nbsp;
                                    <label for="serial${column_count}">Serial</label>
                                </td>
                        </tr>
                        `;
                    }

                    let column_count = 1;
                    const filetypeselect = document.querySelector('#filetypeselect');
                    if (filetypeselect){
                        filetypeselect.addEventListener('change', function(){
                            if (this.value === 'table'){
                                document.querySelector('#file-builder').style.display='block';
                                document.querySelector('#fileheader').style.display='flex';
                                document.querySelector('#fileheader').innerHTML = `
                                    Add Column(s)
                                    &nbsp;
                                    <button type="button" onclick="add_column()">+</button>
                                `;
                                document.querySelector('#filecontents').innerHTML = `
                                    <table id="filecontents-table">
                                        <tr>
                                            <th>Column Name</th>
                                            <th>Column Type</th>
                                            <th>Column Constraint</th>
                                        </tr>
                                        <tr>
                                            <td><input type="text" name="columnname1"></td>    
                                            <td class="column-type-div">
                                                <select name="columntype1" class="column-type">
                                                    <option value="int">Int</option>
                                                    <option value="float">Float</option>
                                                    <option value="string">String</option> 
                                                    <option value="derivative">Derivative</option>    
                                                </select>  
                                                
                                                <input
                                                    type="text"
                                                    name="derivativeinfo"
                                                    class="derivative-input"
                                                    placeholder="Formula / logic"
                                                    style="display:none; margin-top:4px;"
                                                >
                                            </td>
                                            <td class="constraints">
                                                <input type="checkbox" name="notnull1">&nbsp;
                                                <label for="notnull1">Not Null</label>&nbsp;

                                                <input type="checkbox" name="primarykey1">&nbsp;
                                                <label for="primarykey1">Primary Key</label>&nbsp;

                                                <input type="checkbox" name="unique1">&nbsp;
                                                <label for="unique1">Unique</label>&nbsp;

                                                <input type="checkbox" name="serial1">&nbsp;
                                                <label for="serial1">Serial</label>
                                            </td>
                                        </tr>    
                                    </table>
                                `;
                            }
                            else if (this.value === 'json'){
                                document.querySelector('#file-builder').style.display='none';
                                document.querySelector('#fileheader').style.display='none';
                            }
                        });
                    }

                    document.addEventListener('change', function (e) {
                        if (!e.target.name.startsWith('primarykey')) return;

                        if (e.target.checked) {
                            document
                                .querySelectorAll('input[name^="primarykey"]')
                                .forEach(cb => {
                                    if (cb !== e.target) cb.checked = false;
                                });
                        }
                    });

                    document.addEventListener('change', function (e) {
                    if (!e.target.classList.contains('column-type')) return;

                        const typeCell = e.target.closest('td');
                        const row = e.target.closest('tr');

                        const derivativeInput = typeCell.querySelector('.derivative-input');
                        const constraintsCell = row.querySelector('.constraints');

                        if (!derivativeInput || !constraintsCell) return;

                        const constraintInputs = constraintsCell.querySelectorAll('input');

                        if (e.target.value === 'derivative') {
                            derivativeInput.style.display = 'block';

                            constraintInputs.forEach(i => {
                            i.checked = false;
                            i.disabled = true;
                            });

                        } else {
                            derivativeInput.style.display = 'none';
                            derivativeInput.value = '';

                            constraintInputs.forEach(i => {
                            i.disabled = false;
                            });
                        }
                    });

                </script>
            <% } %>
            </div>
        <%}%>
    </div>
</body>
<script>

    // file click and tool show script start
    document.querySelectorAll('.filename').forEach(function(file){
        file.addEventListener('click', function(){
            
            document.querySelector('#tools form #form-filename').value = file.querySelector('.filenamefull_hidden').innerText.trim();
            document.querySelector('#tools form #form-databasename').value = file.querySelector('.databasename_hidden').innerText.trim();

            if (file.querySelector('.filename-hidden').innerHTML.trim() === 'txt'){
                showbuttonset('3');
            }
            else if (file.querySelector('.filename-hidden').innerHTML.trim() === 'json'){
                showbuttonset('4');
            }

        });
    });

    function showbuttonset(number){
        document.querySelectorAll('#tools form .button-set').forEach(element => {
            element.style.display='none';
        });
        document.querySelector(`#button-set-${number}`).style.display='flex';
        let mode_text;
        if (number === '1'){
            mode_text = 'Tool Mode'
        }
        else if (number === '2'){
            mode_text = 'Create Mode'
        }
        else if (number === '3'){
            mode_text = 'Table Mode'
        }
        else if (number === '4'){
            mode_text = 'JSON Mode'
        }
        else if (number === '5'){
            mode_text = 'Join Mode'
        }
        else if (number === '6'){
            mode_text = 'Split Mode'
        }
        else if (number === '7'){
            mode_text = 'Delete Mode'
        }
        else if (number === '8'){
            mode_text = 'Rename Mode'
        }
        document.querySelector('#tool-mode').innerHTML = mode_text;
        // document.querySelector('tool-mode').style.diplay='block';
    }

    // file click and tool show script end

    // sidebar search and active highlight block start

    document.querySelectorAll(".database-name span").forEach(span => {
        span.addEventListener("click", function() {
            // Rotate the arrow
            span.classList.toggle("change");

            // Find the UL inside the same .database-name
            const ul = span.parentElement.querySelector("ul");
            if (ul) {
                ul.classList.toggle("show");
            }
        });
    });

    function filterSidebar(){
    const query = document
        .getElementById("sidebar-search-input")
        .value.toLowerCase();

    document.querySelectorAll(".database-name").forEach(db => {
        let dbName = db.textContent.toLowerCase();
        let matchFound = false;

        const files = db.querySelectorAll(".filename");

        files.forEach(file => {
            const fileName = file.textContent.toLowerCase();
            if (fileName.includes(query)) {
                file.style.display = "flex";
                matchFound = true;
            } else {
                file.style.display = "none";
            }
        });

        // Show DB if db name matches OR any file matches
        if (dbName.includes(query) || matchFound || query === "") {
            db.style.display = "block";
            if (query !== "" && matchFound) {
                db.querySelector("ul").classList.add("show");
                db.querySelector("span").classList.add("change");
            }
        } else {
            db.style.display = "none";
        }
    });
}

    document.querySelectorAll(".filename").forEach(file => {
    file.addEventListener("click", function(){
        document
            .querySelectorAll(".filename")
            .forEach(f => f.classList.remove("active"));

        this.classList.add("active");
    });
});
    // sidebar search and active highlight block end


    function cancel_popup(){
        document.querySelector('.popup').style.display='none';
    }

    
    // popup-management-block
    {
        if ("<%= message1%>"){
            document.querySelector('.popup').style.display='block';
            // document.querySelector('#popup').style.border='2px solid black';
        }
        if ("<%=message1%>"==="tableschema" || "<%= message1%>"==="jsonschema" || "<%= message1%>"==="querytool" ){
            document.querySelector('.popup').style.display='none';
        }
    }

    //popup-drag-logic

    let isDragging = false;
    let offsetX = 0;
    let offsetY = 0;

    document.addEventListener("mousedown", function(e){
        const handle = e.target.closest(".popup-drag-handle");
        if (!handle) return;

        const popup = handle.closest(".popup-card");
        isDragging = true;

        const rect = popup.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;

        popup.style.transform = "none"; // stop centering transform
    });

    document.addEventListener("mousemove", function(e){
        if (!isDragging) return;

        const popup = document.querySelector(".popup-card");
        if (!popup) return;

        let x = e.clientX - offsetX;
        let y = e.clientY - offsetY;

        // keep inside viewport
        const maxX = window.innerWidth - popup.offsetWidth;
        const maxY = window.innerHeight - popup.offsetHeight;

        x = Math.max(10, Math.min(x, maxX - 10));
        y = Math.max(10, Math.min(y, maxY - 10));

        popup.style.left = x + "px";
        popup.style.top = y + "px";
    });

    document.addEventListener("mouseup", function(){
        isDragging = false;
    });

    
</script>

</html>