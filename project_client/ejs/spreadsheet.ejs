<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataNest - Spreadsheet View</title>
    <link rel="stylesheet" href="/spreadsheet.css">
</head>
<body>
    <!-- Top Bar -->
    <div id="top-bar">
        <div id="heading">
            <a href="/">Data<span>Nest</span></a>
        </div>

        <div id="user">
            <div class="user-avatar" id="user-toggle">
                <%= username.charAt(0).toUpperCase() %>
            </div>

            <div id="user-name">
                <%= username.charAt(0).toUpperCase() + username.slice(1) %>
            </div>

            <!-- Dropdown -->
            <form id="user-dropdown" class="hidden" action="/user_dropdown" method="POST">
                <button type="submit" name="submit" value="profile" class="dropdown-item">üë§ Profile</button>
                <button type="submit" name="submit" value="workspace" class="dropdown-item">üñ•Ô∏è Workspace</button>
                <button type="submit" name="submit" value="logout" class="dropdown-item logout">üö™ Logout</button>
            </form>
        </div>
    </div>

    <!-- Spreadsheet Container -->
    <div class="spreadsheet-wrapper">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <button type="submit" class="btn-toolbar" id="saveBtn">üíæ Save Changes</button>
                <button class="btn-toolbar" id="addRowBtn">‚ûï Add Row</button>
                <button class="btn-toolbar" id="deleteRowBtn">üóëÔ∏è Delete Row</button>
                <button class="btn-toolbar" id="addColumnBtn">‚ûï Add Column</button>
                <button class="btn-toolbar" id="deleteColumnBtn">üóëÔ∏è Delete Column</button>
                <button class="btn-toolbar" id="undoBtn">‚Ü∂ Undo</button>
            </div>
            <div class="toolbar-right">
                <span class="cell-info" id="cellInfo">Click a cell to edit</span>
            </div>
        </div>

        <!-- Spreadsheet Grid -->
        <div class="spreadsheet-container">
            <div class="spreadsheet-scroll">
                <table class="spreadsheet" id="spreadsheet">
                    <thead>
                        <tr>
                            <th class="row-header">#</th>
                            <% columns.forEach((col, index) => { %>
                                <th class="column-header" data-column="<%= col.name %>">
                                    <input type="hidden" name="columnname<%=index+1%>" value="<%=col.name%>">
                                    <input type="hidden" name="columntype<%=index+1%>" value="<%=col.type%>">
                                    <input type="hidden" name="columnexpression<%=index+1%>" value="<%=col.expression%>">
                                    <%= col.name %>
                                    <span class="column-type"><%= col.type %></span>

                                    <% if (col.constraints.includes('primary_key')) { %>
                                        <span class="given-constraint pk" title="Primary Key">üîë</span>
                                        <input type="hidden" name="primary_key_<%=index%>" value="primary_key">
                                    <% } %>
                                    <% if (col.constraints.includes('unique')) { %>
                                        <span class="given-constraint uq" title="Unique">‚≠ê</span>
                                        <input type="hidden" name="unique_<%=index%>" value="unique">
                                    <% } %>
                                    <% if (col.constraints.includes('not_null')) { %>
                                        <span class="given-constraint nn" title="Not Null">üîí</span>
                                        <input type="hidden" name="not_null_<%=index%>" value="not_null">
                                    <% } %>
                                    <% if (col.constraints.includes('serial')) { %>
                                        <span class="given-constraint sr" title="Auto Increment">üîÅ</span>
                                        <input type="hidden" name="serial_<%=index%>" value="serial">
                                    <% } %>

                                    <% if (col.type === 'derivative' && col.expression) { %>
                                        <span class="expression-icon" title="Expression: <%= col.expression %>">üìê</span>
                                    <% } %>
                                </th>
                            <% }) %>
                        </tr>
                    </thead>
                    <tbody>
                        <% rows.forEach((row, rowIndex) => { %>
                            <tr data-row-index="<%= rowIndex %>">
                                <td class="row-number"><%= rowIndex + 1 %></td>
                                <% columns.forEach((col) => { %>
                                    <td 
                                        class="cell <%= col.type === 'derivative' ? 'derivative-cell' : '' %>" 
                                        data-column="<%= col.name %>"
                                        data-type="<%= col.type %>"
                                        data-row="<%= rowIndex %>"
                                        data-original="<%= row[col.name] %>"
                                        contenteditable="<%= col.type === 'derivative' ? 'false' : 'true' %>"
                                    >
                                        <%= row[col.name] !== null && row[col.name] !== undefined ? row[col.name] : '' %>
                                    </td>
                                <% }) %>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span id="rowCount"><%= rows.length %> rows</span>
                <span class="separator">‚Ä¢</span>
                <span id="colCount"><%= columns.length %> columns</span>
                <span class="separator">‚Ä¢</span>
                <span id="changeCount" class="changes-indicator">0 changes</span>
            </div>
            <div class="status-right">
                <span id="selectedCell">No cell selected</span>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div id="addColumnModal" class="modal hidden">
        <div class="modal-content modal-drag-handle">
            <div class="modal-header">
                <h3>Add New Column</h3>
                <button class="modal-close" id="closeModal">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Column Name:</label>
                    <input type="text" id="newColumnName" placeholder="e.g., TOTAL_SCORE">
                </div>
                <div class="form-group">
                    <label>Column Type:</label>
                    <select id="newColumnType">
                        <option value="string">String</option>
                        <option value="int">Integer</option>
                        <option value="float">Float</option>
                        <option value="derivative">Derivative (Calculated)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Column Constraints:</label>
                    <div class="constraints">
                        <div class="constraint">
                            <input type="checkbox" name="constraints[]" value="not_null">&nbsp;
                            <label>Not Null</label>&nbsp;
                        </div>

                        <div class="constraint">
                            <input type="checkbox" name="constraints[]" value="primary_key">&nbsp;
                            <label>Primary Key</label>&nbsp;
                        </div>

                        <div class="constraint">
                            <input type="checkbox" name="constraints[]" value="unique">&nbsp;
                            <label>Unique</label>&nbsp;
                        </div>

                        <div class="constraint">
                            <input type="checkbox" name="constraints[]" value="serial">&nbsp;
                            <label>Serial</label>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="expressionGroup" style="display: none;">
                    <label>Expression:</label>
                    <input type="text" id="newColumnExpression" placeholder="e.g., AGE + 10">
                    <small>Example: AGE*2 or IF(PERCENTAGE>50,"Pass","Fail")</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelColumnBtn">Cancel</button>
                <button class="btn-primary" id="confirmColumnBtn">Add Column</button>
            </div>
        </div>
    </div>

    <script>
        const userToggle = document.getElementById("user-toggle");
        const dropdown = document.getElementById("user-dropdown");

        userToggle.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown.classList.toggle("hidden");
        });

        document.addEventListener("click", () => {
            dropdown.classList.add("hidden");
        });

        // Spreadsheet Logic
        const spreadsheet = document.getElementById('spreadsheet');
        const saveBtn = document.getElementById('saveBtn');
        const addRowBtn = document.getElementById('addRowBtn');
        const deleteRowBtn = document.getElementById('deleteRowBtn');
        const deleteColumnBtn = document.getElementById('deleteColumnBtn');
        const addColumnBtn = document.getElementById('addColumnBtn');
        const undoBtn = document.getElementById('undoBtn');
        const cellInfo = document.getElementById('cellInfo');
        const selectedCell = document.getElementById('selectedCell');
        const changeCount = document.getElementById('changeCount');

        let changes = {};
        let undoStack = [];
        let currentCell = null;
        let columnsData = <%- JSON.stringify(columns) %>;
        let rowsData = <%- JSON.stringify(rows)%>

        // Track changes
        spreadsheet.addEventListener('input', (e) => {
            if (e.target.classList.contains('cell')) {
                const cell = e.target;
                const row = cell.dataset.row;
                const column = cell.dataset.column;
                const newValue = cell.textContent.trim();
                const originalValue = cell.dataset.original;
                const oldValue = changes[row]?.[column] || originalValue;

                undoStack.push({
                    type: 'edit',
                    row: row,
                    column: column,
                    oldValue: oldValue,
                    newValue: newValue,
                    cell: cell
                });

                // Limit undo stack to 50 actions
                if (undoStack.length > 50) {
                    undoStack.shift();
                }

                if (!changes[row]) changes[row] = {};
                
                if (newValue !== originalValue) {
                    rowsData[parseInt(row)][column] = newValue;
                    changes[row] = rowsData[parseInt(row)];
                    cell.classList.add('modified');
                } else {
                    delete changes[row][column];
                    if (Object.keys(changes[row]).length === 0) delete changes[row];
                    cell.classList.remove('modified');
                }

                updateChangeCount();
                updateUndoButton();
            }
        });

        // Update undo button state
        function updateUndoButton() {
            if (undoStack.length > 0) {
                undoBtn.disabled = false;
                undoBtn.style.opacity = '1';
                undoBtn.style.cursor = 'pointer';
            } else {
                undoBtn.disabled = true;
                undoBtn.style.opacity = '0.5';
                undoBtn.style.cursor = 'not-allowed';
            }
        }

        // Undo last change
        undoBtn.addEventListener('click', () => {
            if (undoStack.length === 0) {
                alert('Nothing to undo');
                return;
            }

            const lastAction = undoStack.pop();

            if (lastAction.type === 'edit') {
                // Restore the old value
                const cell = document.querySelector(
                    `.cell[data-row="${lastAction.row}"][data-column="${lastAction.column}"]`
                );

                if (cell) {
                    cell.textContent = lastAction.oldValue;
                    
                    // Update changes object
                    if (!changes[lastAction.row]) changes[lastAction.row] = {};
                    
                    const originalValue = cell.dataset.original;
                    if (lastAction.oldValue !== originalValue) {
                        changes[lastAction.row][lastAction.column] = lastAction.oldValue;
                        cell.classList.add('modified');
                    } else {
                        delete changes[lastAction.row][lastAction.column];
                        if (Object.keys(changes[lastAction.row]).length === 0) {
                            delete changes[lastAction.row];
                        }
                        cell.classList.remove('modified');
                    }

                    updateChangeCount();
                }
            } else if (lastAction.type === 'addRow') {
                // Remove the added row
                const row = spreadsheet.querySelector(`tbody tr[data-row-index="${lastAction.rowIndex}"]`);
                if (row) row.remove();
                
                const rowCount = spreadsheet.querySelectorAll('tbody tr').length;
                document.getElementById('rowCount').textContent = `${rowCount} rows`;
                
                spreadsheet.querySelectorAll('tbody tr').forEach((tr, index) => {
                    tr.querySelector('.row-number').textContent = index + 1;
                });
            } else if (lastAction.type === 'deleteRow') {
                // Restore the deleted row
                const tbody = spreadsheet.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                
                if (lastAction.index < rows.length) {
                    rows[lastAction.index].insertAdjacentHTML('beforebegin', lastAction.rowHTML);
                } else {
                    tbody.insertAdjacentHTML('beforeend', lastAction.rowHTML);
                }
                
                const rowCount = spreadsheet.querySelectorAll('tbody tr').length;
                document.getElementById('rowCount').textContent = `${rowCount} rows`;
                
                spreadsheet.querySelectorAll('tbody tr').forEach((tr, index) => {
                    tr.querySelector('.row-number').textContent = index + 1;
                });
            } else if (lastAction.type === 'addColumn') {
                // Remove the added column
                const headers = spreadsheet.querySelectorAll('thead th');
                headers[headers.length - 1].remove();
                
                spreadsheet.querySelectorAll('tbody tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells[cells.length - 1].remove();
                });
                
                columnsData.pop();
                
                document.getElementById('colCount').textContent = `${columnsData.length} columns`;
            } else if (lastAction.type === 'deleteColumn') {
                // Restore the deleted column
                const { columnIndex, column, columnData } = lastAction;
                
                // Add back to columnsData
                columnsData.splice(columnIndex, 0, column);
                
                // Add header back
                const headerRow = spreadsheet.querySelector('thead tr');
                const headers = headerRow.querySelectorAll('th');
                const newHeader = document.createElement('th');
                newHeader.className = 'column-header';
                newHeader.dataset.column = column.name;
                newHeader.innerHTML = `
                    ${column.name}
                    <span class="column-type">${column.type}</span>
                    ${column.type === 'derivative' && column.expression ? `<span class="expression-icon" title="Expression: ${column.expression}">üìê</span>` : ''}
                `;
                
                if (columnIndex + 1 < headers.length) {
                    headers[columnIndex + 1].insertAdjacentElement('beforebegin', newHeader);
                } else {
                    headerRow.appendChild(newHeader);
                }
                
                // Add cells back to all rows
                const rows = spreadsheet.querySelectorAll('tbody tr');
                rows.forEach((row, rowIdx) => {
                    const cells = row.querySelectorAll('td');
                    const newCell = document.createElement('td');
                    newCell.className = `cell ${column.type === 'derivative' ? 'derivative-cell' : ''}`;
                    newCell.dataset.column = column.name;
                    newCell.dataset.type = column.type;
                    newCell.dataset.row = rowIdx;
                    newCell.dataset.original = columnData[rowIdx] || '';
                    newCell.contentEditable = column.type !== 'derivative';
                    newCell.textContent = columnData[rowIdx] || '';
                    
                    if (columnIndex + 1 < cells.length) {
                        cells[columnIndex + 1].insertAdjacentElement('beforebegin', newCell);
                    } else {
                        row.appendChild(newCell);
                    }
                    
                    // Restore to rowsData
                    rowsData[rowIdx][column.name] = columnData[rowIdx] || (column.type === 'string' ? '' : null);
                });
                
                // Update column count
                document.getElementById('colCount').textContent = `${columnsData.length} columns`;
            }

            updateUndoButton();
        });

        // Initialize undo button state on page load
        updateUndoButton();

        // Cell selection
        spreadsheet.addEventListener('click', (e) => {
            if (e.target.classList.contains('cell')) {
                // Remove previous selection
                if (currentCell) {
                    currentCell.classList.remove('selected');
                }

                // Add new selection
                currentCell = e.target;
                currentCell.classList.add('selected');

                // Update info
                const column = currentCell.dataset.column;
                const row = parseInt(currentCell.dataset.row) + 1;
                const type = currentCell.dataset.type;
                
                selectedCell.textContent = `Cell: ${column} (Row ${row})`;
                cellInfo.textContent = `Editing: ${column} ‚Ä¢ Type: ${type}`;
            }
        });

        // Save changes
        saveBtn.addEventListener('click', async () => {
            // if (Object.keys(changes).length === 0) {
            //     alert('No changes to save');
            //     return;
            // }

            try {
                //replacing old rows with changed ones
                for (let change in changes){
                    // alert(parseInt(change), rows[parseInt(change)])
                    rowsData[parseInt(change)]=changes[change];
                }
                const response = await fetch('/spreadsheet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filename: '<%= filename %>',
                        databasename: '<%= databasename %>',
                        columns: columnsData,
                        rows: rowsData
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Changes saved successfully!');
                    
                    // Update original values
                    Object.keys(changes).forEach(row => {
                        Object.keys(changes[row]).forEach(column => {
                            const cell = document.querySelector(
                                `.cell[data-row="${row}"][data-column="${column}"]`
                            );
                            if (cell) {
                                cell.dataset.original = changes[row][column];
                                cell.classList.remove('modified');
                            }
                        });
                    });
                    
                    changes = {};
                    updateChangeCount();
                } else {
                    alert('‚ùå Error saving changes: ' + data.message);
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå Error saving changes');
            }
        });

        // Add row
        addRowBtn.addEventListener('click', () => {
            const tbody = spreadsheet.querySelector('tbody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const columns = <%- JSON.stringify(columns) %>;
            
            const newRow = document.createElement('tr');
            newRow.dataset.rowIndex = rowCount;
            
            let rowHTML = `<td class="row-number">${rowCount + 1}</td>`;
            columnsData.forEach(col => {
                const isDerivative = col.type === 'derivative';
                rowHTML += `
                    <td 
                        class="cell ${isDerivative ? 'derivative-cell' : ''}"
                        data-column="${col.name}"
                        data-type="${col.type}"
                        data-row="${rowCount}"
                        data-original=""
                        contenteditable="${!isDerivative}"
                    ></td>
                `;
            });

            //adding new row into the column
            let temp = {};
            columnsData.forEach(c => {
                let value;
                if (c.type === 'string') value="";
                else value=null;
                temp[c.name]=value;
            });
            rowsData.push(temp);
            
            newRow.innerHTML = rowHTML;
            tbody.appendChild(newRow);

            undoStack.push({
                type: 'addRow',
                rowIndex: rowCount
            });
            updateUndoButton();
            
            document.getElementById('rowCount').textContent = `${rowCount + 1} rows`;
        });

        // Delete selected row
        deleteRowBtn.addEventListener('click', () => {
            if (!currentCell) {
                alert('Please select a cell in the row you want to delete');
                return;
            }

            const row = currentCell.closest('tr');
            if (confirm('Are you sure you want to delete this row ?')) {
                const rowIndex = Array.from(row.parentElement.children).indexOf(row);  // ‚Üê ADD
                const rowHTML = row.outerHTML;  // ‚Üê ADD
                
                // ‚Üê ADD THESE LINES
                undoStack.push({
                    type: 'deleteRow',
                    index: rowIndex,
                    rowHTML: rowHTML
                });
                updateUndoButton();
                row.remove();

                //deleting row from data
                rowsData.splice(rowIndex, 1);
                
                const rowCount = spreadsheet.querySelectorAll('tbody tr').length;
                document.getElementById('rowCount').textContent = `${rowCount} rows`;
                
                // Renumber rows
                spreadsheet.querySelectorAll('tbody tr').forEach((tr, index) => {
                    tr.querySelector('.row-number').textContent = index + 1;
                });
            }
        });

        // Delete selected column
        deleteColumnBtn.addEventListener('click', () => {
            if (!currentCell) {
                alert('Please select a cell in the column you want to delete');
                return;
            }

            const columnName = currentCell.dataset.column;
            const columnIndex = columnsData.findIndex(col => col.name === columnName);

            if (columnIndex === -1) {
                alert('Column not found');
                return;
            }

            if (confirm(`Are you sure you want to delete column "${columnName}"?`)) {
                // Store column data for undo
                const deletedColumn = columnsData[columnIndex];
                const columnData = {};
                
                // Collect all cell data from this column
                spreadsheet.querySelectorAll('tbody tr').forEach((row, rowIdx) => {
                    const cell = row.querySelector(`td[data-column="${columnName}"]`);
                    if (cell) {
                        columnData[rowIdx] = cell.textContent;
                    }
                });

                // Add to undo stack
                undoStack.push({
                    type: 'deleteColumn',
                    columnIndex: columnIndex,
                    column: deletedColumn,
                    columnData: columnData
                });
                updateUndoButton();

                // Remove from columnsData
                columnsData.splice(columnIndex, 1);

                // Remove header
                const header = spreadsheet.querySelector(`thead th[data-column="${columnName}"]`);
                if (header) header.remove();

                // Remove cells from all rows
                spreadsheet.querySelectorAll(`tbody td[data-column="${columnName}"]`).forEach(cell => {
                    cell.remove();
                });

                // Remove from rowsData
                rowsData.forEach(row => {
                    delete row[columnName];
                });

                // Update column count
                document.getElementById('colCount').textContent = `${columnsData.length} columns`;

                // Clear current cell selection
                if (currentCell && currentCell.dataset.column === columnName) {
                    currentCell = null;
                    selectedCell.textContent = 'Cell: None';
                    cellInfo.textContent = 'No cell selected';
                }
            }
        });
        // Update change count
        function updateChangeCount() {
            const count = Object.keys(changes).reduce((acc, row) => {
                return acc + Object.keys(changes[row]).length;
            }, 0);
            
            changeCount.textContent = `${count} change${count !== 1 ? 's' : ''}`;
            changeCount.style.color = count > 0 ? '#EF4444' : '#6B7280';
        }

        // Add column - show modal
        const addColumnModal = document.getElementById('addColumnModal');
        const newColumnName = document.getElementById('newColumnName');
        const newColumnType = document.getElementById('newColumnType');
        const newColumnExpression = document.getElementById('newColumnExpression');
        const expressionGroup = document.getElementById('expressionGroup');

        addColumnBtn.addEventListener('click', () => {
            addColumnModal.classList.remove('hidden');
            newColumnName.value = '';
            newColumnType.value = 'string';
            newColumnExpression.value = '';
            expressionGroup.style.display = 'none';
        });

        // Show/hide expression field
        newColumnType.addEventListener('change', () => {
            expressionGroup.style.display = newColumnType.value === 'derivative' ? 'block' : 'none';
            const constraintInputs = document.querySelectorAll('.constraints input');
            if (newColumnType.value === 'derivative') {
                constraintInputs.forEach(i => {
                i.checked = false;
                i.disabled = true;
                });
            } else {
                constraintInputs.forEach(i => {
                i.disabled = false;
                });
            }
        });

        // Close modal
        document.getElementById('closeModal').addEventListener('click', () => {
            addColumnModal.classList.add('hidden');
        });

        document.getElementById('cancelColumnBtn').addEventListener('click', () => {
            addColumnModal.classList.add('hidden');
        });

        // Confirm add column
        document.getElementById('confirmColumnBtn').addEventListener('click', () => {
            const columnName = newColumnName.value.trim();
            const columnType = newColumnType.value;
            const expression = newColumnExpression.value.trim();

            if (!columnName) {
                alert('Please enter a column name');
                return;
            }

            // Check if column already exists
            if (columnsData.some(col => col.name === columnName)) {
                alert('Column with this name already exists!');
                return;
            }

            if (columnType === 'derivative' && !expression) {
                alert('Please enter an expression for derivative column');
                return;
            }

            const constraints = Array.from(
                document.querySelectorAll('.constraints input[name="constraints[]"]:checked')
                ).map(cb => cb.value);



            // Add to columns data
            const newColumn = {
                name: columnName,
                type: columnType,
                expression: expression,
                constraints: constraints
            };
            columnsData.push(newColumn);

            // Add header
            const headerRow = spreadsheet.querySelector('thead tr');
            const newHeader = document.createElement('th');
            newHeader.className = 'column-header';
            newHeader.dataset.column = newColumn.name;
            newHeader.innerHTML = `
                ${newColumn.name}
                <span class="column-type">${newColumn.type}</span>
                ${newColumn.type === 'derivative' && expression ? `<span class="expression-icon" title="Expression: ${expression}">üìê</span>` : ''}
            `;
            headerRow.appendChild(newHeader);

            // Add cells to all existing rows
            const rows = spreadsheet.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                const newCell = document.createElement('td');
                newCell.className = `cell ${newColumn.type === 'derivative' ? 'derivative-cell' : ''}`;
                newCell.dataset.column = newColumn.name;
                newCell.dataset.type = newColumn.type;
                newCell.dataset.row = index;
                newCell.dataset.original = '';
                newCell.contentEditable = newColumn.type !== 'derivative';
                row.appendChild(newCell);
            });

            // Update column count
            document.getElementById('colCount').textContent = `${columnsData.length} columns`;
            
            undoStack.push({
                type: 'addColumn',
                columnName: columnName
            });
            updateUndoButton();

            // Close modal
            addColumnModal.classList.add('hidden');
            
            alert(`‚úÖ Column "${columnName}" added! Remember to save changes.`);
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (!currentCell) return;

            const row = currentCell.closest('tr');
            const cells = Array.from(row.querySelectorAll('.cell'));
            const currentIndex = cells.indexOf(currentCell);

            if (e.key === 'ArrowRight' && currentIndex < cells.length - 1) {
                e.preventDefault();
                cells[currentIndex + 1].click();
                cells[currentIndex + 1].focus();
            } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
                e.preventDefault();
                cells[currentIndex - 1].click();
                cells[currentIndex - 1].focus();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                const nextRow = row.nextElementSibling;
                if (nextRow) {
                    const nextCell = nextRow.querySelectorAll('.cell')[currentIndex];
                    nextCell.click();
                    nextCell.focus();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevRow = row.previousElementSibling;
                if (prevRow) {
                    const prevCell = prevRow.querySelectorAll('.cell')[currentIndex];
                    prevCell.click();
                    prevCell.focus();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const nextRow = row.nextElementSibling;
                if (nextRow) {
                    const nextCell = nextRow.querySelectorAll('.cell')[currentIndex];
                    nextCell.click();
                    nextCell.focus();
                }
            }
        });

        //Modal movement
        let isDragging = false;
        let offsetX = 0;
        let offsetY = 0;

        document.addEventListener("mousedown", function(e){
            const handle = e.target.closest(".modal-drag-handle");
            if (!handle) return;

            const popup = handle.closest(".modal-content");
            isDragging = true;

            const rect = popup.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;

            popup.style.transform = "none"; // stop centering transform
        });

        document.addEventListener("mousemove", function(e){
            if (!isDragging) return;

            const popup = document.querySelector(".modal-content");
            if (!popup) return;

            let x = e.clientX - offsetX;
            let y = e.clientY - offsetY;

            // keep inside viewport
            const maxX = window.innerWidth - popup.offsetWidth;
            const maxY = window.innerHeight - popup.offsetHeight;

            x = Math.max(10, Math.min(x, maxX - 10));
            y = Math.max(10, Math.min(y, maxY - 10));

            popup.style.left = x + "px";
            popup.style.top = y + "px";
        });

        document.addEventListener("mouseup", function(){
            isDragging = false;
        });
    </script>
</body>
</html>